<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Weather Trader</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
:root{
  --bg:#f4f1e8;
  --bg-soft:#edf5ef;
  --surface:#ffffff;
  --surface-soft:#f9fbfa;
  --ink:#18261f;
  --tx:#18261f;
  --dm:#5a6c64;
  --muted:#758680;
  --line:#d2dbd6;
  --bd:#b8c6c0;
  --brand:#0b7f6a;
  --brand-soft:#dff1ec;
  --h1:#2f6fb3;
  --h2:#0e958f;
  --gn:#0f8a47;
  --rd:#c4403b;
  --am:#b86a16;
  --warn-bg:#fff3dc;
  --danger-bg:#fdecea;
  --ok-bg:#e9f7ef;
  --shadow:0 12px 28px rgba(15,27,21,.09);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Outfit',sans-serif;
  color:var(--ink);
  background:
    radial-gradient(1100px 400px at -10% -20%,rgba(15,127,106,.22),transparent 55%),
    radial-gradient(760px 360px at 110% 10%,rgba(47,111,179,.16),transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg-soft));
  padding:22px;
}
.app-shell{
  width:min(1480px,100%);
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.panel,.pn{
  background:var(--surface);
  border:1px solid var(--line);
  border-radius:16px;
  box-shadow:var(--shadow);
}
.top-band{
  display:grid;
  grid-template-columns:minmax(0,1fr) auto;
  gap:18px;
  padding:18px 20px;
}
.eyebrow{
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  letter-spacing:1.4px;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:6px;
}
#hdrTitle{
  font-size:36px;
  line-height:1.05;
  letter-spacing:-.02em;
  font-weight:800;
}
#hdrTitle span{font-weight:500;color:var(--muted)}
.status-side{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.status-list{display:flex;flex-direction:column;align-items:flex-end;gap:5px}
#badge{
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
  color:#0c6c5a;
  background:var(--brand-soft);
  border:1px solid rgba(11,127,106,.35);
  border-radius:999px;
  padding:6px 12px;
}
#stationInfo,#ut{
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  color:var(--dm);
}
.city-panel{padding:14px 16px}
#cityNav{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(175px,1fr));
  gap:8px;
}
.sb-item{
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:var(--surface-soft);
  padding:11px 12px;
  cursor:pointer;
  transition:.16s ease;
}
.sb-item:hover{transform:translateY(-1px);border-color:#97b0a6;background:#f2f7f4}
.sb-item.active{
  border-color:rgba(11,127,106,.5);
  background:linear-gradient(90deg,rgba(11,127,106,.12),rgba(11,127,106,.03));
}
.sb-flag{font-size:16px}
.sb-meta{
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  color:var(--muted);
}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:7px 12px;
  background:var(--surface);
  color:var(--dm);
}
.chip b{color:var(--tx)}
.chip-live{background:var(--ok-bg);border-color:rgba(15,138,71,.35);color:var(--gn)}
.chip-pause{background:var(--danger-bg);border-color:rgba(196,64,59,.35);color:var(--rd)}
.chip-info{background:var(--brand-soft);border-color:rgba(11,127,106,.35);color:var(--brand)}
.warn{
  border:1px solid #ecd39f;
  background:var(--warn-bg);
  color:#79531a;
  border-radius:12px;
  padding:10px 12px;
  font-size:13px;
  line-height:1.45;
}
.warn b{color:#4c330f}
.note-active{
  border-color:#8ab7a8;
  background:#eaf7f2;
  color:#1e5b4b;
}
.workspace{
  display:grid;
  grid-template-columns:minmax(0,1.7fr) minmax(320px,1fr);
  gap:12px;
  align-items:start;
}
.panel-main{padding:14px;display:flex;flex-direction:column;gap:10px}
.side-stack{display:flex;flex-direction:column;gap:10px}
.stats{display:grid;grid-template-columns:repeat(2,minmax(130px,1fr));gap:8px}
.st{
  border:1px solid var(--line);
  border-radius:12px;
  padding:11px;
  background:var(--surface-soft);
}
.st-l{
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--muted);
  margin-bottom:5px;
}
.st-v{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700}
.st-s{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);margin-top:4px}
.dtabs{display:flex;gap:7px;overflow-x:auto;padding-bottom:2px}
.dtab{
  border:1px solid var(--line);
  border-radius:999px;
  background:var(--surface);
  color:var(--dm);
  padding:7px 11px;
  white-space:nowrap;
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  cursor:pointer;
}
.dtab:hover{border-color:#93aba2;color:var(--ink)}
.dtab.active{background:var(--ink);border-color:var(--ink);color:#f4fbf8}
.dtab .dtag{font-size:9px;margin-left:4px;padding:2px 5px;border-radius:999px}
.dtab .dtag-today{background:rgba(15,138,71,.16);color:var(--gn)}
.dtab .dtag-past{background:rgba(90,108,100,.16);color:#506159}
.dtab .dtag-future{background:rgba(11,127,106,.16);color:var(--brand)}
.sb-sig{
  border:1px solid var(--line);
  border-radius:14px;
  background:linear-gradient(135deg,#f5faf8,#ffffff);
  padding:12px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  justify-content:space-between;
  align-items:center;
}
.sg-t{
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:1.2px;
  color:var(--muted);
  margin-bottom:3px;
}
.sg-n{font-size:30px;font-weight:800;line-height:1}
.sg-d{display:flex;gap:12px;flex-wrap:wrap}
.si{text-align:right}
.si-l{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.si-v{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:700}
.sg-reasons{width:100%;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dm)}
.pn{padding:13px}
.pt{
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:1.2px;
  color:var(--muted);
  margin-bottom:9px;
}
.table-scroll{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:940px}
thead th{
  position:sticky;
  top:0;
  z-index:1;
  background:#e7f3ee;
  border-bottom:1px solid #c9ddd4;
  color:#25463c;
  padding:9px 6px;
  text-align:right;
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.6px;
}
thead th:first-child{text-align:left}
tbody td{
  border-bottom:1px solid #e7efea;
  padding:8px 6px;
  text-align:right;
  color:var(--dm);
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
}
tbody td:first-child{text-align:left;color:var(--tx);font-weight:700}
tbody tr:nth-child(even) td{background:#fbfdfc}
.rh td{background:rgba(15,138,71,.05)}
.tot{
  margin-top:9px;
  border-top:1px dashed #c6d4cd;
  padding-top:9px;
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
}
.tb{display:inline-block;padding:2px 7px;border-radius:999px;font-size:9px;font-weight:700;letter-spacing:.4px}
.tb-b{background:rgba(15,138,71,.16);color:var(--gn)}
.tb-s{background:rgba(196,64,59,.16);color:var(--rd)}
.tb-l{background:rgba(11,127,106,.16);color:var(--brand)}
.tb-blocked{background:rgba(184,106,22,.16);color:var(--am);cursor:help}
.mfav{display:inline-block;padding:2px 7px;border-radius:999px;background:rgba(11,127,106,.16);color:var(--brand);font-weight:700}
.pos-w td{box-shadow:inset 4px 0 0 rgba(47,111,179,.4)}
.pos-l{opacity:.45}
.split-panels{display:grid;grid-template-columns:1fr;gap:10px}
.hist{display:flex;align-items:flex-end;gap:5px;height:126px;margin:8px 0}
.hc{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%}
.hbs{display:flex;gap:3px;align-items:flex-end;width:100%;justify-content:center;flex:1}
.hb1,.hb2,.hb3{width:28%;border-radius:2px;transition:height .3s ease}
.hp,.hl{font-family:'JetBrains Mono',monospace;color:var(--muted)}
.hp{font-size:10px;margin-bottom:2px}
.hl{font-size:11px;margin-top:4px}
#log{
  max-height:330px;
  overflow:auto;
  border:1px solid #d6e3dd;
  border-radius:12px;
  padding:10px;
  background:#f5faf8;
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  line-height:1.62;
}
.lo{color:#325248}
.le{color:#9c332f}
.lw{color:#9d6315}
.config-shell{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.api-grid{display:grid;grid-template-columns:repeat(3,minmax(150px,1fr));gap:10px}
.cfg-grid-min{display:grid;grid-template-columns:repeat(3,minmax(120px,1fr));gap:10px}
.field{display:flex;flex-direction:column;gap:5px}
.field label{
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--muted);
}
.field input,.cfg-input{
  border:1px solid var(--line);
  border-radius:10px;
  background:var(--surface-soft);
  color:var(--tx);
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
  padding:9px 10px;
}
.field input:focus,.cfg-input:focus{outline:none;border-color:#67a191;box-shadow:0 0 0 3px rgba(11,127,106,.13)}
.btn{
  border:1px solid var(--line);
  border-radius:999px;
  background:#f5f8f7;
  color:var(--tx);
  font-family:'JetBrains Mono',monospace;
  font-size:11px;
  font-weight:700;
  padding:8px 12px;
  cursor:pointer;
}
.btn:hover{border-color:#8fa69d}
.btn-primary{border-color:#78a999;background:#e8f4ef;color:#1f6454}
.ctl{display:flex;align-items:center;gap:8px}
.sw{display:inline-flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dm)}
.sw input{display:none}
.sw span{position:relative;width:38px;height:20px;background:#cdd9d3;border:1px solid #97aaa1;border-radius:999px}
.sw span::after{content:'';position:absolute;top:1px;left:1px;width:16px;height:16px;border-radius:50%;background:#fff;border:1px solid #96aaa0;transition:.2s}
.sw input:checked + span{background:#8cd7c6}
.sw input:checked + span::after{left:19px}
.ft{
  font-family:'JetBrains Mono',monospace;
  font-size:10px;
  color:var(--muted);
  padding:2px 3px;
}
.ft a{color:#236a5b;text-decoration:underline;text-underline-offset:3px}
@media(max-width:1180px){
  .workspace{grid-template-columns:1fr}
  .config-shell{grid-template-columns:1fr}
}
@media(max-width:900px){
  body{padding:12px}
  .top-band{grid-template-columns:1fr;gap:10px}
  .status-side{align-items:flex-start}
  .status-list{align-items:flex-start}
  #hdrTitle{font-size:28px}
  .stats{grid-template-columns:1fr}
  .api-grid,.cfg-grid-min{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="app-shell" id="tradingPage">
  <header class="top-band panel">
    <div>
      <p class="eyebrow">Weather Trader Dashboard</p>
      <h1 id="hdrTitle">Loading... <span></span></h1>
    </div>
    <div class="status-side">
      <div class="ctl">
        <label class="sw" title="Pause/resume live trading bot">
          <input id="botSwitch" type="checkbox" onchange="toggleBotPause()">
          <span></span>
          <em id="botSwitchLabel" style="font-style:normal">Bot ON</em>
        </label>
      </div>
      <div class="status-list">
        <div id="badge">Starting...</div>
        <span id="stationInfo">â€”</span>
        <span id="ut">â€”</span>
      </div>
    </div>
  </header>

  <section class="panel city-panel">
    <div class="pt">City Markets</div>
    <div id="cityNav"></div>
  </section>

  <section class="chips">
    <div class="chip chip-live" id="chipBankroll">Bankroll: <b>â€”</b></div>
    <div class="chip" id="chipExposure">Exposure: <b>â€”</b></div>
    <div class="chip" id="chipActive">Active positions: <b>0</b></div>
    <div class="chip" id="chipMode">Mode: <b>â€”</b></div>
    <div class="chip" id="chipApi">API: <b>offline</b></div>
  </section>

  <div class="warn note-active" id="activePosNotice" style="display:none"></div>

  <div class="workspace">
    <main class="panel panel-main">
      <div class="warn" id="biasWarn"></div>

      <div class="dtabs" id="dateTabs"></div>

      <div id="entryTiming" style="display:none;padding:8px 14px;border-radius:12px;margin-bottom:2px;font-size:12px;border:1px solid var(--dm)"></div>
      <div id="stopLossWarn" style="display:none;padding:10px 14px;border-radius:12px;margin-bottom:2px;font-size:13px;font-weight:700;border:1px solid var(--rd);background:rgba(220,38,38,.04);color:var(--rd)"></div>

      <div class="sb-sig" id="sigB">
        <div>
          <div class="sg-t" id="sigT" style="color:var(--dm)">Connecting...</div>
          <div class="sg-n" id="sigN">â€”</div>
        </div>
        <div class="sg-d" id="sigD"></div>
        <div class="sg-reasons" id="blockedSummary"></div>
      </div>

      <div class="pn">
        <div class="pt">Bracket Analysis</div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th style="text-align:left">Bracket</th>
                <th style="text-align:center">Signal</th>
                <th>Raw %</th>
                <th>Corrected %</th>
                <th>Market %</th>
                <th>Bid</th>
                <th>Ask</th>
                <th>Spread</th>
                <th>Raw Edge</th>
                <th style="color:var(--gn)">True Edge</th>
                <th>Models</th>
                <th>Bet</th>
                <th>E[P]</th>
              </tr>
            </thead>
            <tbody id="tbl"></tbody>
          </table>
        </div>
        <div class="tot" id="totals"></div>
      </div>
    </main>

    <aside class="side-stack">
      <section class="panel" style="padding:12px">
        <div class="stats">
          <div class="st"><div class="st-l">Forecast Source</div><div class="st-v" id="curT">â€”</div><div class="st-s" id="curTs">â€”</div></div>
          <div class="st"><div class="st-l">Tomorrow Max</div><div class="st-v" id="dH">â€”</div><div class="st-s" id="dHs">â€”</div></div>
          <div class="st"><div class="st-l">Predicted Bracket</div><div class="st-v" id="ensMean">â€”</div><div class="st-s" id="ensSrc">loading...</div></div>
          <div class="st"><div class="st-l">Execution</div><div class="st-v">SIM</div><div class="st-s">forward test only</div></div>
        </div>
      </section>

      <div class="split-panels">
        <div class="pn" id="histPanel" style="display:none">
          <div class="pt">Distribution: Raw â†’ Corrected â†’ Market</div>
          <div class="hist" id="hist"></div>
          <div style="display:flex;gap:14px;margin-top:6px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dm)">
            <span style="color:var(--h1)">â—¼ Raw</span>
            <span style="color:var(--h2)">â—¼ Corrected</span>
            <span style="opacity:.35">â—¼ Market</span>
          </div>
        </div>

        <div class="pn" id="logPanel">
          <div class="pt">Live Bot Log</div>
          <div id="log"></div>
        </div>
      </div>
    </aside>
  </div>

  <section class="config-shell">
    <div class="pn">
      <div class="pt">Live Control</div>
      <div class="api-grid">
        <div class="field">
          <label>API Base URL</label>
          <input id="apiBase" placeholder="http://178.62.253.211:8090">
        </div>
        <div class="field">
          <label>API Token</label>
          <input id="apiToken" type="password" placeholder="x-api-key">
        </div>
        <div class="field">
          <label>Actions</label>
          <div style="display:flex;gap:6px">
            <button class="btn" onclick="saveApiSettings()">Save</button>
            <button class="btn btn-primary" onclick="refreshSummary(true)">Connect</button>
          </div>
        </div>
      </div>
      <div id="apiMsg" style="margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dm)"></div>
    </div>

    <div class="pn">
      <div class="pt">Risk Parameters (Live Bot)</div>
      <div class="cfg-grid-min">
        <div class="field"><label>Max Bet Ratio</label><input id="cfgMaxBetRatio" type="number" step="0.01" min="0" max="1"></div>
        <div class="field"><label>Max Exposure Ratio</label><input id="cfgMaxExposureRatio" type="number" step="0.01" min="0" max="1"></div>
        <div class="field"><label>Daily Loss Ratio</label><input id="cfgDailyLossRatio" type="number" step="0.01" min="0" max="1"></div>
        <div class="field"><label>Min Ask Depth</label><input id="cfgMinAskDepth" type="number" step="1" min="0"></div>
        <div class="field"><label>Max Ask Price</label><input id="cfgMaxAskPrice" type="number" step="0.01" min="0" max="1"></div>
        <div class="field"><label>Order Timeout (sec)</label><input id="cfgOrderTimeout" type="number" step="1" min="30"></div>
        <div class="field"><label>City Min Edge</label><input id="cfgCityMinEdge" type="number" step="0.01" min="0" max="0.5"></div>
        <div class="field"><label>City Min Models</label><input id="cfgCityMinModels" type="number" step="1" min="1"></div>
        <div class="field"><label>City Min Families</label><input id="cfgCityMinFamilies" type="number" step="1" min="1"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <button class="btn btn-primary" onclick="saveRuntimeConfig()">Save Live Config</button>
        <span id="cfgMsg" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dm)"></span>
      </div>
    </div>
  </section>

  <div class="ft" id="footer">â€”</div>
</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITY CONFIGURATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CITIES={
  london:{
    name:"London",flag:"ğŸ‡¬ğŸ‡§",icao:"EGLC",lat:51.5053,lon:0.0553,
    unit:"C",stationName:"London City Airport",
    polyCity:"london",tz:"Europe/London",
    wunderground:"https://www.wunderground.com/history/daily/gb/london/EGLC",
    // 176 members: ICON(39)+ECMWF IFS(50)+ECMWF AIFS(50)+GEM(20)+UKMO(17)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble,ecmwf_aifs025_ensemble,gem_global_ensemble,ukmo_global_ensemble_20km",
    syntheticModel:null,
    bias:{mean:0.17,sd:0.66,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  seoul:{
    name:"Seoul",flag:"ğŸ‡°ğŸ‡·",icao:"RKSI",lat:37.4602,lon:126.4407,
    unit:"C",stationName:"Incheon Intl Airport",
    polyCity:"seoul",tz:"Asia/Seoul",
    wunderground:"https://www.wunderground.com/history/daily/kr/incheon/RKSI",
    // 120 ensemble + 10 KMA synthetic = ~130 members
    // Dropped: ICON(1.7 RMSE), UKMO(2.8 RMSE), GFS(2.4), JMA(2.2)
    ensembleModels:"ecmwf_ifs025_ensemble,ecmwf_aifs025_ensemble,gem_global_ensemble",
    syntheticModel:"kma_seamless", // Korea's own model, best for Seoul (0.9 RMSE) but no ensemble
    bias:{mean:0.69,sd:0.86,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  nyc:{
    name:"NYC",flag:"ğŸ‡ºğŸ‡¸",icao:"KLGA",lat:40.7772,lon:-73.8726,
    unit:"F",stationName:"LaGuardia Airport",
    polyCity:"nyc",tz:"America/New_York",
    wunderground:"https://www.wunderground.com/history/daily/us/ny/new-york-city/KLGA",
    // 89 members: ICON(39)+ECMWF IFS(50). ECMWF has +2.8F bias, corrected via MC
    // Dropped: GEM(4.0 RMSE), JMA(4.6), UKMO(2.7)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble",
    syntheticModel:null,
    bias:{mean:1.79,sd:2.49,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  seattle:{
    name:"Seattle",flag:"ğŸ‡ºğŸ‡¸",icao:"KSEA",lat:47.4502,lon:-122.3088,
    unit:"F",stationName:"Seattle-Tacoma Intl",
    polyCity:"seattle",tz:"America/Los_Angeles",
    wunderground:"https://www.wunderground.com/history/daily/us/wa/seatac/KSEA",
    // 109 members: ICON(39)+ECMWF IFS(50)+GEM(20). All ~same bias, consistent correction
    // Dropped: UKMO(2.9 RMSE), JMA(2.6)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble,gem_global_ensemble",
    syntheticModel:null,
    bias:{mean:1.66,sd:1.93,note:"45-day METAR backtest Jan-Feb 2026"},
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CITY=CITIES.london; // active city
let B=[]; // bracket labels â€” populated dynamically from Polymarket
let TOKENS={};
const KELLY_FRAC=0.30,RS=60;
const LIVE_MODE=true,BR=25;
const FILTERS={minEdge:0.05,minDepth:20,maxAsk:0.50,minModels:2,bankroll:25};
const CITY_FILTERS={
  london:{minEdge:0.05,minModels:3,maxAsk:0.50},
  seoul:{minEdge:0.05,minModels:3,maxAsk:0.50},
  nyc:{minEdge:0.08,minModels:2,maxAsk:0.50},
  seattle:{minEdge:0.05,minModels:2,maxAsk:0.50},
};
const LATE_GUARD_CONFIG={
  enabled:true,
  defaultCutoffHour:15,
  cutoffByCity:{london:15,seoul:15,nyc:16,seattle:16},
  freezeHoursAfterCutoff:6,
  favoriteOnlyAfterCutoff:true,
  minEdgeAfterCutoff:0.08,
  freezeAllNewEntries:true,
};
function F(){return {...FILTERS,...(CITY_FILTERS[CITY.polyCity]||{})}}

let prices={},books={},rawProbs={},corrProbs={},ensMean=0,ensCount=0;
let gasCostUsd=0.03,polPrice=0.35,metarTemp=null,metarHigh=null,metarDayMax=null;
let cd=RS,pxi=0;
const EXEC_CONFIG={
  enabled:true,
  feeRate:0.0,             // weather markets are usually fee-free
  gasUsdPerOrder:0.0,      // keep 0 to match bot defaults
  useLiveGasEstimate:false, // optional: use gasCostUsd estimate
  spreadRef:0.04,          // 4c spread reference
  queuePenalty:0.50,
  minFill:0.05,
  maxFill:0.98
};

const $=id=>document.getElementById(id);
let LOCAL_LOG_LINES=[];
let BACKEND_LOG_LINES=[];
let USE_BACKEND_LOGS=true;
function escHtml(v){return String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function renderLocalLogs(){
  const el=$("log");if(!el)return;
  el.innerHTML=LOCAL_LOG_LINES.map(x=>`<div class="${x.c||'lo'}">[${x.t}] ${escHtml(x.m)}</div>`).join("");
}
function renderBackendLogs(){
  const el=$("log");if(!el)return;
  if(!BACKEND_LOG_LINES.length){el.innerHTML='<div class="lo">Waiting for backend logs...</div>';return}
  el.innerHTML=BACKEND_LOG_LINES.map(line=>`<div class="lo">${escHtml(line)}</div>`).join("");
}
function log(m,c=""){
  const t=new Date().toLocaleTimeString();
  LOCAL_LOG_LINES.unshift({t,m,c:c||"lo"});
  if(LOCAL_LOG_LINES.length>120)LOCAL_LOG_LINES.length=120;
  if(!USE_BACKEND_LOGS||!API_CONNECTED)renderLocalLogs();
}

let API_BASE=localStorage.getItem("wt_api_base")||"";
let API_TOKEN=localStorage.getItem("wt_api_token")||"";
let ACTIVE_MARKET_BRACKETS={};
let BOT_PAUSED=false;
let RUNTIME_EFFECTIVE={};
let API_CONNECTED=false;
window._forwardMode=false;
window._forwardPredictedBracket=null;

function uniq(arr){return [...new Set(arr.filter(Boolean))]}
function escAttr(v){return String(v??"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}
function renderBlockedSummary(rows){
  const el=$("blockedSummary");if(!el)return;
  if(!rows||!rows.length){el.innerHTML="";return}
  const counts={};
  for(const row of rows){
    for(const reason of (row.filterReasons||[])){
      const key=String(reason||"").trim();
      if(!key)continue;
      counts[key]=(counts[key]||0)+1;
    }
  }
  const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,4);
  if(!top.length){el.innerHTML="";return}
  const msg=top.map(([reason,count])=>`${count}Ã— ${reason}`).join(" Â· ");
  el.innerHTML=`Blocked by: <span title="${escAttr(msg)}">${escHtml(msg)}</span>`;
}

function apiBaseCandidates(){
  const sameOrigin=location.origin?.startsWith("http")?location.origin:"";
  const host8090=(location.hostname&&location.hostname!=="localhost"&&location.hostname!=="127.0.0.1")
    ?`${location.protocol==="https:"?"https":"http"}://${location.hostname}:8090`
    :"";
  return uniq([API_BASE,sameOrigin,host8090,"http://178.62.253.211:8090"]);
}

function setApiMsg(msg,isErr=false){
  const el=$("apiMsg");if(!el)return;
  el.textContent=msg||"";
  el.style.color=isErr?"var(--rd)":"var(--dm)";
}

function updateTopChips(summary){
  const cash=summary?.bankroll?.cash;
  const exp=summary?.portfolio?.active_exposure;
  const active=summary?.portfolio?.active_positions;
  const key=`${cityDisplayName(CITY.name)}:${ACTIVE_DATE.dateStr}`;
  const currentMarketActive=(summary?.active_by_market?.[key]||[]).length;
  const strategyEngine=summary?.strategy_engine||"";
  const mode=(strategyEngine==="forward_test_tomorrow")
    ?"forward_test"
    :(summary?.control?.mode||"manual");
  BOT_PAUSED=!!summary?.control?.paused;
  $("chipBankroll").innerHTML=`Bankroll: <b>${cash>=0?`$${Number(cash).toFixed(2)}`:"â€”"}</b>`;
  $("chipExposure").innerHTML=`Exposure: <b>${typeof exp==="number"?`$${exp.toFixed(2)}`:"â€”"}</b>`;
  $("chipActive").innerHTML=`Active positions: <b>${Number(active||0)}</b>${currentMarketActive?` Â· this market <b>${currentMarketActive}</b>`:""}`;
  $("chipMode").innerHTML=`Mode: <b>${mode}${BOT_PAUSED?" Â· paused":""}</b>`;
  $("chipMode").className=`chip ${BOT_PAUSED?"chip-pause":"chip-live"}`;
  setBotSwitchUi(BOT_PAUSED);
}

function setApiConnected(ok){
  API_CONNECTED=!!ok;
  const el=$("chipApi");
  el.innerHTML=`API: <b>${ok?"connected":"offline"}</b>`;
  el.className=`chip ${ok?"chip-live":"chip-pause"}`;
  el.title=ok
    ?"Connected to live bot API."
    :"API offline means dashboard cannot reach live bot backend, so bankroll/exposure/active positions cannot update.";
}

function setBotSwitchUi(paused){
  const sw=$("botSwitch"),lbl=$("botSwitchLabel");
  if(!sw||!lbl)return;
  sw.checked=!paused;
  lbl.textContent=paused?"Bot OFF":"Bot ON";
  localStorage.setItem("wt_last_bot_paused",paused?"1":"0");
}

function initBotSwitchFromCache(){
  const v=localStorage.getItem("wt_last_bot_paused");
  setBotSwitchUi(v==="1");
}

function loadCachedSummary(){
  try{
    const raw=localStorage.getItem("wt_last_summary");
    if(!raw)return false;
    const s=JSON.parse(raw);
    ACTIVE_MARKET_BRACKETS=s.active_by_market||{};
    RUNTIME_EFFECTIVE=s.runtime_effective||{};
    updateTopChips(s);
    fillConfigInputs(RUNTIME_EFFECTIVE);
    updateActivePositionNotice();
    setApiMsg("Showing last known live values. API offline right now.",true);
    return true;
  }catch(e){
    return false;
  }
}

function cityDisplayName(key){
  if(key==="NYC")return "NYC";
  return key;
}

function activeBracketSetForCurrentMarket(){
  const k=`${cityDisplayName(CITY.name)}:${ACTIVE_DATE.dateStr}`;
  return new Set(ACTIVE_MARKET_BRACKETS[k]||[]);
}

function updateActivePositionNotice(){
  const list=Array.from(activeBracketSetForCurrentMarket());
  const el=$("activePosNotice");
  if(!el)return;
  if(!list.length){
    el.style.display="none";
    return;
  }
  el.style.display="block";
  el.innerHTML=`Active in this market: <b>${list.join(", ")}</b>. Duplicate BUY on same bracket is blocked.`;
}

function authHeaders(){
  const h={"Content-Type":"application/json"};
  if(API_TOKEN)h["X-API-Key"]=API_TOKEN;
  return h;
}

async function apiGet(path){
  if(!API_BASE)throw new Error("API base URL not set");
  const r=await fetch(`${API_BASE}${path}`,{headers:authHeaders(),signal:AbortSignal.timeout(8000)});
  if(!r.ok)throw new Error(`HTTP ${r.status}`);
  const j=await r.json();
  if(!j.ok)throw new Error(j.error||"API error");
  return j.data;
}

async function apiPost(path,payload){
  if(!API_BASE)throw new Error("API base URL not set");
  const r=await fetch(`${API_BASE}${path}`,{
    method:"POST",
    headers:authHeaders(),
    body:JSON.stringify(payload||{}),
    signal:AbortSignal.timeout(8000),
  });
  if(!r.ok)throw new Error(`HTTP ${r.status}`);
  const j=await r.json();
  if(!j.ok)throw new Error(j.error||"API error");
  return j.data;
}

function loadApiSettingsToInputs(){
  if(!API_BASE){
    const cands=apiBaseCandidates();
    API_BASE=cands.find(v=>v!==location.origin)||cands[0]||"";
  }
  if($("apiBase"))$("apiBase").value=API_BASE;
  if($("apiToken"))$("apiToken").value=API_TOKEN;
}

function saveApiSettings(){
  API_BASE=($("apiBase").value||"").trim().replace(/\/$/,"");
  API_TOKEN=($("apiToken").value||"").trim();
  localStorage.setItem("wt_api_base",API_BASE);
  localStorage.setItem("wt_api_token",API_TOKEN);
  setApiMsg("Saved API settings.");
  refreshSummary(true);
}

function fillConfigInputs(eff){
  if(!eff)return;
  $("cfgMaxBetRatio").value=eff.max_bet_ratio ?? "";
  $("cfgMaxExposureRatio").value=eff.max_exposure_ratio ?? "";
  $("cfgDailyLossRatio").value=eff.daily_loss_ratio ?? "";
  $("cfgMinAskDepth").value=eff.min_ask_depth ?? "";
  $("cfgMaxAskPrice").value=eff.max_ask_price ?? "";
  $("cfgOrderTimeout").value=eff.order_timeout_seconds ?? "";
  const cityCfg=(eff.city_thresholds||{})[CITY.polyCity]||{};
  $("cfgCityMinEdge").value=cityCfg.min_edge ?? "";
  $("cfgCityMinModels").value=cityCfg.min_models ?? "";
  $("cfgCityMinFamilies").value=cityCfg.min_families ?? "";
}

async function refreshSummary(manual=false){
  const bases=apiBaseCandidates();
  let lastErr="unknown";
  for(const base of bases){
    try{
      API_BASE=(base||"").replace(/\/$/,"");
      if(!API_BASE)continue;
      const s=await apiGet("/api/summary");
      localStorage.setItem("wt_api_base",API_BASE);
      localStorage.setItem("wt_last_summary",JSON.stringify(s));
    ACTIVE_MARKET_BRACKETS=s.active_by_market||{};
    RUNTIME_EFFECTIVE=s.runtime_effective||{};
    updateTopChips(s);
    fillConfigInputs(RUNTIME_EFFECTIVE);
    updateActivePositionNotice();
    if(B.length&&Object.keys(prices).length)render();
    setApiConnected(true);
      if(manual)setApiMsg(`Connected to live bot API (${API_BASE}).`);
      return;
    }catch(e){
      lastErr=e.message;
    }
  }
  setApiConnected(false);
  updateActivePositionNotice();
  const hasCached=loadCachedSummary();
  if(manual){
    setApiMsg(`API offline: ${lastErr}. Check API base URL and VPS port/API service.`,true);
  }else if(!hasCached){
    setApiMsg("API offline. Fill API base URL in Live Control and click Connect.",true);
  }
}

async function refreshLiveLogs(){
  if(!API_CONNECTED)return;
  try{
    const data=await apiGet("/api/dashboard/logs?lines=120");
    if(Array.isArray(data?.lines)){
      BACKEND_LOG_LINES=data.lines;
      if(USE_BACKEND_LOGS)renderBackendLogs();
    }
  }catch(e){
    // Keep local logs visible on failure.
  }
}

async function saveRuntimeConfig(){
  try{
    const payload={};
    const f=(id)=>{const n=parseFloat($(id).value);return Number.isFinite(n)?n:null};
    const i=(id)=>{const n=parseInt($(id).value,10);return Number.isFinite(n)?n:null};
    const put=(k,v)=>{if(v!==null)payload[k]=v};
    put("max_bet_ratio",f("cfgMaxBetRatio"));
    put("max_exposure_ratio",f("cfgMaxExposureRatio"));
    put("daily_loss_ratio",f("cfgDailyLossRatio"));
    put("min_ask_depth",i("cfgMinAskDepth"));
    put("max_ask_price",f("cfgMaxAskPrice"));
    put("order_timeout_seconds",i("cfgOrderTimeout"));
    const cityOverride={};
    const cEdge=f("cfgCityMinEdge");
    const cModels=i("cfgCityMinModels");
    const cFamilies=i("cfgCityMinFamilies");
    if(cEdge!==null)cityOverride.min_edge=cEdge;
    if(cModels!==null)cityOverride.min_models=cModels;
    if(cFamilies!==null)cityOverride.min_families=cFamilies;
    if(Object.keys(cityOverride).length)payload.city_overrides={[CITY.polyCity]:cityOverride};
    const d=await apiPost("/api/config",payload);
    RUNTIME_EFFECTIVE=d.effective||{};
    fillConfigInputs(RUNTIME_EFFECTIVE);
    $("cfgMsg").textContent="Saved to live bot.";
    $("cfgMsg").style.color="var(--gn)";
    await refreshSummary(false);
  }catch(e){
    $("cfgMsg").textContent=`Save failed: ${e.message}`;
    $("cfgMsg").style.color="var(--rd)";
  }
}

async function toggleBotPause(){
  const sw=$("botSwitch");
  const targetPaused=!sw.checked;
  if(!API_CONNECTED){
    sw.checked=!targetPaused;
    setApiMsg("API offline: cannot change bot ON/OFF right now.",true);
    return;
  }
  try{
    await apiPost("/api/bot/pause",{paused:targetPaused});
    BOT_PAUSED=targetPaused;
    setBotSwitchUi(BOT_PAUSED);
    setApiMsg(BOT_PAUSED?"Bot paused from dashboard.":"Bot resumed from dashboard.");
    await refreshSummary(false);
  }catch(e){
    sw.checked=!targetPaused;
    setApiMsg(`Bot switch failed: ${e.message}`,true);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cToF(c){return c*9/5+32}
function fToC(f){return(f-32)*5/9}
function ensToMarket(tempC){return CITY.unit==="F"?cToF(tempC):tempC}
function unitLabel(){return"Â°"+CITY.unit}
function clip(x,lo,hi){return Math.max(lo,Math.min(hi,x))}
function localDateInTZ(tz){return new Date().toLocaleDateString("en-CA",{timeZone:tz})}
function cityTimeText(tz){
  const now=new Date();
  const d=now.toLocaleDateString("en-CA",{timeZone:tz});
  const t=now.toLocaleTimeString("en-GB",{timeZone:tz,hour12:false});
  return `${tz} ${d} ${t}`;
}
function updateCityClock(){
  const el=$("ut");
  if(!el||!CITY||!CITY.tz)return;
  el.textContent=cityTimeText(CITY.tz);
}
function localHourInTZ(tz){
  const parts=new Intl.DateTimeFormat("en-GB",{timeZone:tz,hour12:false,hour:"2-digit",minute:"2-digit"}).formatToParts(new Date());
  const hh=parseInt((parts.find(p=>p.type==="hour")||{}).value||"0",10);
  const mm=parseInt((parts.find(p=>p.type==="minute")||{}).value||"0",10);
  return hh+mm/60;
}

function topAskDepth(book,ask){
  if(!book||!book.asks)return 0;
  let d=0;
  for(const lvl of book.asks){
    const px=parseFloat(lvl.price||0),sz=parseFloat(lvl.size||0);
    if(Math.abs(px-ask)<=1e-9)d+=Math.max(0,sz);
    else if(px>ask)break;
  }
  return d;
}

function estimateExecution(book,ask,contracts){
  if(!book||contracts<=0){
    return{
      topAskDepth:0,immediateFillFraction:1,continuationFillProb:1,fillFraction:1,slippagePenalty:0
    };
  }
  const spread=Math.max(0,book.spd||0),askDepth=Math.max(0,book.askD||0),topDepth=topAskDepth(book,ask);
  const immediate=clip(topDepth/Math.max(1,contracts),0,1);
  const spreadRef=Math.max(0.0001,EXEC_CONFIG.spreadRef);
  const spreadScore=clip(1-(spread/spreadRef),0,1);
  const depthScore=clip(askDepth/Math.max(1,contracts),0,1);
  const qPenalty=clip((spread/spreadRef)*EXEC_CONFIG.queuePenalty,0,0.8);
  const continuation=clip(0.10+0.55*spreadScore+0.35*depthScore-qPenalty,EXEC_CONFIG.minFill,EXEC_CONFIG.maxFill);
  const fill=immediate+(1-immediate)*continuation;
  const slip=spread*(1-immediate)*0.50;
  return{
    topAskDepth:topDepth,
    immediateFillFraction:immediate,
    continuationFillProb:continuation,
    fillFraction:clip(fill,EXEC_CONFIG.minFill,1),
    slippagePenalty:Math.max(0,slip),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DYNAMIC BRACKET PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseBracket(label){
  // Returns {type,low,high,val,unit} for matching temps to brackets
  const isF=label.includes("Â°F"),u=isF?"F":"C";
  if(label.includes("or below")||label.includes("or less")){
    const m=label.match(/([-\d]+)/);return{type:"below",high:parseInt(m[1]),unit:u}}
  if(label.includes("or higher")||label.includes("or above")){
    const m=label.match(/([-\d]+)/);return{type:"above",low:parseInt(m[1]),unit:u}}
  const rm=label.match(/([-\d]+)[\s]*[-â€“][\s]*([-\d]+)/);
  if(rm)return{type:"range",low:parseInt(rm[1]),high:parseInt(rm[2]),unit:u};
  const sm=label.match(/([-\d]+)/);
  if(sm)return{type:"single",val:parseInt(sm[1]),unit:u};
  return null;
}

function tempToBracket(temp){
  // temp in market units, match against current B array
  const rd=Math.round(temp);
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.type==="below"&&rd<=p.high)return label;
    if(p.type==="above"&&rd>=p.low)return label;
    if(p.type==="single"&&rd===p.val)return label;
    if(p.type==="range"&&rd>=p.low&&rd<=p.high)return label;
  }
  return B[0]||null; // fallback to lowest
}

function bracketShortLabel(label){
  return label.replace(/Â°[CF]\s*or below/,"â‰¤").replace(/Â°[CF]\s*or higher/,"+").replace(/Â°[CF]/,"");
}

function bracketRange(){
  // Get min/max degree values from brackets for Monte Carlo range
  let mn=999,mx=-999;
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.val!==undefined){mn=Math.min(mn,p.val);mx=Math.max(mx,p.val)}
    if(p.low!==undefined)mn=Math.min(mn,p.low);
    if(p.high!==undefined)mx=Math.max(mx,p.high);
  }
  return{min:mn-5,max:mx+5}; // padding for Monte Carlo tails
}

function isImpossibleAfterObservedHigh(label,observedHigh){
  if(observedHigh==null)return false;
  const p=parseBracket(label);if(!p)return false;
  const obs=parseFloat(observedHigh);
  if(Number.isNaN(obs))return false;
  if(p.type==="below")return obs>p.high;
  if(p.type==="single")return obs>p.val;
  if(p.type==="range")return obs>p.high;
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITY SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectCity(key){
  CITY=CITIES[key];
  // Reset all state
  B=[];TOKENS={};prices={};books={};rawProbs={};corrProbs={};
  ensMean=0;ensCount=0;metarTemp=null;metarHigh=null;metarDayMax=null;
  _marketsDiscovered=false;
  // Immediately clear analysis display to prevent stale brackets showing
  $("tbl").innerHTML="";$("totals").innerHTML="";$("hist").innerHTML="";
  $("sigT").textContent="Loading...";$("sigN").textContent="â€”";$("sigD").innerHTML="";$("blockedSummary").innerHTML="";
  $("sigB").style.borderColor="var(--bd)";
  $("dHs").textContent="loading...";
  $("ensSrc").textContent="loading...";
  // Update UI
  renderCityNav();
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span></span>";
  $("stationInfo").textContent=CITY.icao+" "+CITY.lat.toFixed(3)+"Â°N "+Math.abs(CITY.lon).toFixed(3)+"Â°"+(CITY.lon>=0?"E":"W");
  $("curTs").textContent="station "+CITY.icao;
  $("curT").textContent="â€”";$("dH").textContent="â€”";$("ensMean").textContent="â€”";
  // Forward-test banner
  $("biasWarn").innerHTML=`<b>Forward Test</b>: Tomorrow.io ${CITY.tz} forecast + live CLOB books. v5 filters/orders are disabled.`;
  $("biasWarn").style.display="";
  // Update footer
  $("footer").innerHTML=`Forward test mode Â· Forecast source: Tomorrow.io Â· Resolution reference: <a href="${CITY.wunderground}" target="_blank">Wunderground ${CITY.icao}</a>`;
  // Re-initialize dates for this city
  ACTIVE_DATE=buildDateConfig(new Date().toISOString().split("T")[0]);
  ALL_DATES=generateDates().map(buildDateConfig);
  fillConfigInputs(RUNTIME_EFFECTIVE);
  updateActivePositionNotice();
  renderDateTabs();
  log("Switched to "+CITY.name+" ("+CITY.icao+")","lo");
  refresh();
}

function renderCityNav(){
  $("cityNav").innerHTML=Object.entries(CITIES).map(([key,c])=>{
    const active=c.icao===CITY.icao?"active":"";
    return`<div class="sb-item ${active}" onclick="selectCity('${key}')">
      <span class="sb-flag">${c.flag}</span>
      <div><div>${c.name}</div><div class="sb-meta">${c.icao} Â· Â°${c.unit}</div></div>
    </div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADING MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilters(a){
  if(window._forwardMode){
    if(a.bracket===window._forwardPredictedBracket){
      return {pass:true,reasons:[]};
    }
    return {pass:false,reasons:["Forward test: only predicted bracket is simulated"]};
  }
  const f=F(),reasons=[];
  if(!a.isCandidate)reasons.push("Outside favorite Â±1");
  if(a.trueEdge<f.minEdge)reasons.push(`Edge ${(a.trueEdge*100).toFixed(1)}pt < ${(f.minEdge*100)}pt min`);
  if(a.askD<f.minDepth&&f.minDepth>0)reasons.push(`Depth ${a.askD.toFixed(0)} < ${f.minDepth} min`);
  if(a.ask>f.maxAsk&&f.maxAsk<1)reasons.push(`Ask ${(a.ask*100).toFixed(0)}Â¢ > ${(f.maxAsk*100)}Â¢ max`);
  if(f.minModels>0&&a.modelVotes!==undefined&&a.modelVotes<f.minModels)reasons.push(`Only ${a.modelVotes}/${CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)} models agree (need ${f.minModels})`);
  if(a.lateImpossible)reasons.push(`Observed high ${a.observedHighText} already above bracket`);
  if(a.latePhase==="freeze"&&LATE_GUARD_CONFIG.freezeAllNewEntries)reasons.push("Late freeze window");
  if(a.latePhase==="after_cutoff"&&LATE_GUARD_CONFIG.favoriteOnlyAfterCutoff&&!a.isFavorite)reasons.push("Late cutoff: non-favorite blocked");
  if((a.latePhase==="after_cutoff"||a.latePhase==="freeze")&&a.trueEdge<LATE_GUARD_CONFIG.minEdgeAfterCutoff){
    reasons.push(`Late edge ${(a.trueEdge*100).toFixed(1)}pt < ${(LATE_GUARD_CONFIG.minEdgeAfterCutoff*100).toFixed(0)}pt`);
  }
  return{pass:reasons.length===0&&a.trueEdge>0,reasons};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS=["january","february","march","april","may","june","july","august","september","october","november","december"];
const MONTHS_SHORT=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function buildDateConfig(dateStr){
  const d=new Date(dateStr+"T12:00:00Z");
  const y=d.getUTCFullYear(),m=d.getUTCMonth(),day=d.getUTCDate();
  const monthName=MONTHS[m],monthShort=MONTHS_SHORT[m];
  const dayPad=String(day).padStart(2,"0");
  const today=new Date();today.setUTCHours(12,0,0,0);
  const todayStr=today.toISOString().split("T")[0];
  const isToday=dateStr===todayStr,isPast=dateStr<todayStr,isFuture=dateStr>todayStr;
  const slug=`highest-temperature-in-${CITY.polyCity}-on-${monthName}-${day}-${y}`;
  return{
    dateStr,dayOfMonth:day,dayPad,
    display:`${monthShort} ${day} ${y}`,displayShort:`${monthShort} ${day}`,
    slug,polyUrl:`https://gamma-api.polymarket.com/events?slug=${slug}`,
    ensDatePrefix:`${y}-${String(m+1).padStart(2,"0")}-${dayPad}`,
    metarDayPattern:new RegExp(`${CITY.icao}\\s+${dayPad}\\d{4}Z`),
    // Timezone-aware local date filter for METAR obsTime (epoch secs)
    // Wunderground convention: 00:00 belongs to previous day (end of day, not start)
    metarLocalDateFilter: function(obsTimeSec){
      if(!obsTimeSec) return false;
      try{
        const d=new Date(obsTimeSec*1000);
        const localDate=d.toLocaleDateString('en-CA',{timeZone:CITY.tz}); // YYYY-MM-DD
        if(localDate!==dateStr) return false;
        // Exclude exact midnight (00:00:00) â€” Wunderground assigns it to previous day
        const localTime=d.toLocaleTimeString('en-GB',{timeZone:CITY.tz,hour12:false});
        return localTime!=="00:00:00";
      }catch(e){return false}
    },
    startUTC:`${dateStr}T00:00:00Z`,
    endUTC:(()=>{const n=new Date(d);n.setUTCDate(n.getUTCDate()+1);return n.toISOString().split("T")[0]+"T00:00:00Z"})(),
    isToday,isPast,isFuture,
  };
}

function generateDates(){
  const dates=[],today=new Date();today.setUTCHours(12,0,0,0);
  for(let offset=-3;offset<=1;offset++){const d=new Date(today);d.setUTCDate(d.getUTCDate()+offset);dates.push(d.toISOString().split("T")[0])}
  return dates;
}

let ACTIVE_DATE=buildDateConfig(new Date().toISOString().split("T")[0]);
let ALL_DATES=generateDates().map(buildDateConfig);
let LIVE_MARKETS={};

async function discoverMarkets(){
  try{
    const payload=await apiGet(`/api/dashboard/markets?city=${encodeURIComponent(CITY.polyCity)}`);
    const dates=Array.isArray(payload?.dates)?payload.dates:[];
    LIVE_MARKETS={};
    ALL_DATES=dates.map(x=>{
      const dc=buildDateConfig(x.date_str);
      LIVE_MARKETS[dc.dateStr]={exists:true,active:!!x.active,closed:!!x.closed};
      return {...dc,marketExists:true,active:!!x.active,closed:!!x.closed};
    });
  }catch(e){
    log("Market discovery API failed: "+e.message,"le");
    ALL_DATES=[];
  }
  if(!ALL_DATES.length){ALL_DATES=[buildDateConfig(new Date().toISOString().split("T")[0])];log("No markets found â€” fallback to today","lw")}
  if(!ALL_DATES.find(dc=>dc.dateStr===ACTIVE_DATE.dateStr)){
    const today=new Date().toISOString().split("T")[0];
    const fb=ALL_DATES.find(dc=>dc.dateStr===today)||ALL_DATES[0];
    if(fb)ACTIVE_DATE=buildDateConfig(fb.dateStr);
  }
  renderDateTabs();
  log("Found "+ALL_DATES.length+" "+CITY.name+" markets","lo");
}

function selectDate(dateStr){
  ACTIVE_DATE=buildDateConfig(dateStr);
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span>Â· "+ACTIVE_DATE.display+"</span>";
  document.querySelector("title").textContent="Weather Trader â€” "+CITY.name+" "+ACTIVE_DATE.displayShort;
  $("dH").textContent="â€”";$("dHs").textContent=ACTIVE_DATE.isToday?"Awaiting data":(ACTIVE_DATE.isPast?"Loading...":"Forecast only");
  metarHigh=null;metarTemp=null;metarDayMax=null;
  B=[];prices={};books={};TOKENS={};rawProbs={};corrProbs={};ensMean=0;ensCount=0;
  document.querySelectorAll(".dtab").forEach(t=>t.classList.toggle("active",t.dataset.date===dateStr));
  updateActivePositionNotice();
  refresh();
}

function renderDateTabs(){
  const c=$("dateTabs");
  if(!ALL_DATES.length){c.innerHTML=`<div style="color:var(--dm);font-size:11px">Discovering markets...</div>`;return}
  c.innerHTML=ALL_DATES.map(dc=>{
    const active=dc.dateStr===ACTIVE_DATE.dateStr?"active":"";
    const mkt=LIVE_MARKETS[dc.dateStr]||{};
    let tag,tagClass;
    if(mkt.closed){tag="CLOSED";tagClass="dtag-past"}
    else if(dc.isToday){tag="TODAY";tagClass="dtag-today"}
    else if(dc.isFuture){tag="UPCOMING";tagClass="dtag-future"}
    else{tag="PAST";tagClass="dtag-past"}
    return`<div class="dtab ${active}" data-date="${dc.dateStr}" onclick="selectDate('${dc.dateStr}')">${dc.displayShort}<span class="dtag ${tagClass}">${tag}</span></div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIAS CORRECTION (generalized)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t^=t+Math.imul(t^t>>>7,61|t);return((t^t>>>14)>>>0)/4294967296}}

function biasCorrect(rawDistByDeg){
  // rawDistByDeg: {degreeInMarketUnits: probability}
  // Returns corrected distribution in same units
  if(CITY.bias.sd===0)return{...rawDistByDeg}; // no correction, pass through
  const N=50000,rng=mulberry32(42);
  const range=bracketRange();
  const counts={};
  for(let i=range.min;i<=range.max;i++)counts[i]=0;
  // Find median degree for fallback
  const allDegs=Object.keys(rawDistByDeg).map(Number);
  const medDeg=allDegs.length?allDegs[Math.floor(allDegs.length/2)]:0;
  for(let i=0;i<N;i++){
    let r=rng(),cum=0,baseDeg=medDeg;
    for(const[deg,prob] of Object.entries(rawDistByDeg)){
      cum+=prob;if(r<=cum){baseDeg=parseInt(deg);break}
    }
    const baseT=baseDeg+(rng()-0.5);
    const u1=rng(),u2=rng();
    const z=Math.sqrt(-2*Math.log(u1+1e-10))*Math.cos(2*Math.PI*u2);
    const metarT=baseT+CITY.bias.mean+CITY.bias.sd*z;
    const rounded=Math.round(metarT);
    if(rounded>=range.min&&rounded<=range.max)counts[rounded]++;
  }
  const total=Object.values(counts).reduce((s,v)=>s+v,0);
  const result={};
  for(let i=range.min;i<=range.max;i++){if(counts[i]>0)result[i]=counts[i]/total}
  return result;
}

function mapToLabels(distByDeg){
  // Map degree-keyed distribution to bracket-label-keyed distribution
  const r={};
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.type==="below")r[label]=Object.entries(distByDeg).filter(([k])=>parseInt(k)<=p.high).reduce((s,[,v])=>s+v,0);
    else if(p.type==="above")r[label]=Object.entries(distByDeg).filter(([k])=>parseInt(k)>=p.low).reduce((s,[,v])=>s+v,0);
    else if(p.type==="single")r[label]=distByDeg[p.val]||0;
    else if(p.type==="range")r[label]=Object.entries(distByDeg).filter(([k])=>{const d=parseInt(k);return d>=p.low&&d<=p.high}).reduce((s,[,v])=>s+v,0);
  }
  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH FUNCTIONS (all parameterized by CITY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchDashboardSnapshot(){
  try{
    const snap=await apiGet(`/api/dashboard/snapshot?city=${encodeURIComponent(CITY.polyCity)}&date=${encodeURIComponent(ACTIVE_DATE.dateStr)}`);
    const market=snap.market||{};
    B=Array.isArray(market.brackets)?market.brackets:[];
    prices=market.prices||{};
    TOKENS=market.token_ids||{};
    books=snap.books||{};

    const ens=snap.ensemble||{};
    rawProbs=ens.raw_probs||{};
    corrProbs=ens.corrected_probs||{};
    ensMean=Number(ens.mean||0);
    ensCount=Number(ens.count||0);
    window._modelAgreement=ens.model_agreement||{};
    const fwd=snap.forward_test||null;
    window._forwardMode=!!fwd;
    window._forwardPredictedBracket=fwd?.predicted_bracket||null;
    if(fwd){
      $("ensMean").textContent=fwd.predicted_bracket||"â€”";
      const sim=fwd.simulated_trade||{};
      $("ensSrc").textContent=`${fwd.timestep||"1h"} Â· ask ${(Number(sim.ask||0)*100).toFixed(1)}Â¢`;
      $("curT").textContent="Tomorrow.io";
      $("curTs").textContent=fwd.as_of_utc?`as of ${String(fwd.as_of_utc).substring(11,16)} UTC`:"live";
      const maxVal=Number(fwd.max_temp_market);
      if(Number.isFinite(maxVal)){
        $("dH").textContent=CITY.unit==="F"?`${Math.round(maxVal)}Â°F`:`${maxVal.toFixed(1)}Â°C`;
      }else{
        $("dH").textContent="â€”";
      }
      $("dHs").textContent=`Predicted daily max (${fwd.timestep||"1h"})`;
      metarTemp=null;metarHigh=null;metarDayMax=null;
    }else{
      $("ensMean").textContent=ensCount?ensMean.toFixed(1)+unitLabel():"â€”";
      $("ensSrc").textContent=ensCount?`${ensCount} members Â· backend`:"error";

      const met=snap.metar||{};
      metarTemp=typeof met.current_temp_c==="number"?met.current_temp_c:null;
      metarHigh=typeof met.day_high_c==="number"?met.day_high_c:null;
      metarDayMax=met.day_high_market==null?null:met.day_high_market;
      if(metarTemp!=null){
        const displayTemp=CITY.unit==="F"?cToF(metarTemp).toFixed(0)+"Â°F":metarTemp+"Â°C";
        $("curT").textContent=displayTemp;
      }else{$("curT").textContent="â€”"}
      const latestRaw=String(met.latest_raw||"");
      if(latestRaw.toLowerCase().includes("open-meteo"))$("curTs").textContent="Open-Meteo (not METAR)";
      else if(latestRaw)$("curTs").textContent="METAR "+latestRaw.substring(5,16);
      else $("curTs").textContent="METAR unavailable";
      if(metarDayMax!=null){
        $("dH").textContent=CITY.unit==="F"?`${Math.round(metarDayMax)}Â°F`:`${metarDayMax}Â°C`;
        $("dHs").textContent="METAR max "+ACTIVE_DATE.displayShort;
      }else{
        $("dH").textContent="â€”";
        $("dHs").textContent=ACTIVE_DATE.isToday?"Awaiting data":(ACTIVE_DATE.isPast?"Loading...":"Forecast only");
      }
    }

    const gas=snap.gas||{};
    if(typeof gas.gas_usd==="number")gasCostUsd=gas.gas_usd;
    if(typeof gas.pol_usd==="number")polPrice=gas.pol_usd;

    log(`Snapshot API: ${CITY.name} ${ACTIVE_DATE.displayShort} (${B.length} brackets)`,"lo");
  }catch(e){
    B=[];prices={};TOKENS={};books={};
    rawProbs={};corrProbs={};ensMean=0;ensCount=0;
    window._forwardMode=false;
    window._forwardPredictedBracket=null;
    $("ensMean").textContent="â€”";$("ensSrc").textContent="error";
    log("Snapshot API: "+e.message,"le");
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  if(!B.length||!Object.keys(prices).length)return;
  if(!Object.keys(corrProbs).length&&!Object.keys(rawProbs).length)return;
  const useRaw=!Object.keys(corrProbs).length; // if no corrected, use raw
  const ma=window._modelAgreement||{};
  const favoriteLabel=B.reduce((best,label)=>{
    const bk=books[label],ask=bk?bk.ba:(prices[label]||0);
    if(ask>best.ask)return{label,ask};
    return best;
  },{label:null,ask:-1}).label;
  const favoriteIdx=B.indexOf(favoriteLabel);
  const candidateSet=new Set([favoriteIdx-1,favoriteIdx,favoriteIdx+1].filter(i=>i>=0&&i<B.length).map(i=>B[i]));
  const nowLocalHour=localHourInTZ(CITY.tz);
  const localDateNow=localDateInTZ(CITY.tz);
  const cutoffHour=LATE_GUARD_CONFIG.cutoffByCity[CITY.polyCity]??LATE_GUARD_CONFIG.defaultCutoffHour;
  const freezeHour=Math.min(23,cutoffHour+LATE_GUARD_CONFIG.freezeHoursAfterCutoff);
  const lateApplies=LATE_GUARD_CONFIG.enabled&&localDateNow===ACTIVE_DATE.dateStr;
  const latePhase=lateApplies?(nowLocalHour>=freezeHour?"freeze":nowLocalHour>=cutoffHour?"after_cutoff":"normal"):"inactive";
  const activeNow=activeBracketSetForCurrentMarket();
  const A=B.map(b=>{
    const rawP=rawProbs[b]||0,corP=(useRaw?rawP:corrProbs[b])||0,bk=books[b],mkt=prices[b]||0;
    const ask=bk?bk.ba:mkt,bid=bk?bk.bb:0,mid=bk?bk.mid:mkt;
    const rawEdge=corP-mid;
    const baseTrueEdge=corP-ask;
    const pb=parseBracket(b);
    const deg=pb?(pb.val??pb.low??pb.high??0):0;
    const modelVotes=ma[deg]||0;
    const isFavorite=b===favoriteLabel;
    const isCandidate=candidateSet.has(b);
    const lateImpossible=lateApplies?isImpossibleAfterObservedHigh(b,metarDayMax):false;
    // Check neighboring degrees for range brackets
    let mv=modelVotes;
    if(pb&&pb.type==="range"){for(let d=pb.low;d<=pb.high;d++)mv=Math.max(mv,ma[d]||0)}
    let bet=0,ev=0,sig="PASS",fFull=0,contracts=0;
    let fillFraction=1,immediateFillFraction=1,continuationFillProb=1;
    let feePerContract=0,gasPerContract=0,slippagePenalty=0;
    let effectiveAsk=ask,edgeAfterCosts=baseTrueEdge,trueEdge=baseTrueEdge;
    if(ask>0&&ask<1&&corP>0){
      // Pass 1: rough size for execution estimate
      const bo0=(1-ask)/ask,q0=1-corP;
      const f0=Math.max(0,(bo0*corP-q0)/bo0);
      const bet0=Math.round(f0*KELLY_FRAC*BR*100)/100;
      const hint=Math.max(1,Math.floor(bet0/ask)||1);

      let est=estimateExecution(bk,ask,hint);
      fillFraction=est.fillFraction;
      immediateFillFraction=est.immediateFillFraction;
      continuationFillProb=est.continuationFillProb;
      slippagePenalty=EXEC_CONFIG.enabled?est.slippagePenalty:0;

      feePerContract=EXEC_CONFIG.enabled?ask*EXEC_CONFIG.feeRate:0;
      const gasPerOrder=EXEC_CONFIG.useLiveGasEstimate?gasCostUsd:EXEC_CONFIG.gasUsdPerOrder;
      gasPerContract=EXEC_CONFIG.enabled?gasPerOrder/hint:0;
      effectiveAsk=Math.min(0.99,ask+feePerContract+gasPerContract+slippagePenalty);

      const kPrice=EXEC_CONFIG.enabled?effectiveAsk:ask;
      if(kPrice>0&&kPrice<1){
        const bo=(1-kPrice)/kPrice,q=1-corP;
        fFull=(bo*corP-q)/bo;
        const fillMult=EXEC_CONFIG.enabled?fillFraction:1;
        const fK=Math.max(0,fFull*KELLY_FRAC*fillMult);
        bet=Math.round(fK*BR*100)/100;
        contracts=bet>0?Math.floor(bet/ask):0;
      }

      // Pass 2: recompute costs with final size
      if(contracts>0){
        est=estimateExecution(bk,ask,contracts);
        fillFraction=est.fillFraction;
        immediateFillFraction=est.immediateFillFraction;
        continuationFillProb=est.continuationFillProb;
        slippagePenalty=EXEC_CONFIG.enabled?est.slippagePenalty:0;
        feePerContract=EXEC_CONFIG.enabled?ask*EXEC_CONFIG.feeRate:0;
        gasPerContract=EXEC_CONFIG.enabled?gasPerOrder/contracts:0;
        effectiveAsk=Math.min(0.99,ask+feePerContract+gasPerContract+slippagePenalty);
      }

      edgeAfterCosts=corP-effectiveAsk;
      trueEdge=EXEC_CONFIG.enabled?edgeAfterCosts*fillFraction:edgeAfterCosts;
      ev=contracts>0?Math.round(contracts*fillFraction*edgeAfterCosts*100)/100:0;
    }
    if(trueEdge>.03)sig="BUY";else if(trueEdge>0)sig="LEAN";
    const row={bracket:b,rawP,corP,mktP:prices[b]||0,bid,ask,mid,spread:bk?bk.spd:0,
      rawEdge,baseTrueEdge,trueEdge,edgeAfterCosts,effectiveAsk,fillFraction,immediateFillFraction,
      continuationFillProb,feePerContract,gasPerContract,slippagePenalty,executionAdjusted:EXEC_CONFIG.enabled,
      bet,ev,sig,fFull,contracts,bidD:bk?bk.bidD:0,askD:bk?bk.askD:0,last:bk?bk.last:0,modelVotes:mv,
      isFavorite,isCandidate,isActive:activeNow.has(b),latePhase,lateImpossible,observedHighText:metarDayMax==null?"â€”":String(metarDayMax)};
    if(row.isActive){
      row.sig="ACTIVE";
      row.filterReasons=["Already holding this bracket"];
      row.bet=0;
      row.ev=0;
    }else if(LIVE_MODE&&(sig==="BUY"||sig==="LEAN")){
      const filt=applyFilters(row);
      if(!filt.pass){row.sig="FILTERED";row.filterReasons=filt.reasons;row.bet=0;row.ev=0}
    }
    return row;
  });

  // Signal banner
  const actionable=A.filter(a=>a.sig==="BUY").sort((a,b)=>b.trueEdge-a.trueEdge);
  const filtered=A.filter(a=>a.sig==="FILTERED");
  const activeRows=A.filter(a=>a.sig==="ACTIVE");
  const best=actionable[0];
  const bn=$("sigB");
  if(best){
    bn.style.borderColor="rgba(22,163,74,.2)";$("sigT").style.color="var(--gn)";
    $("sigT").textContent="BUY (strict filters passed)";
    $("sigN").textContent=best.bracket;
    $("sigD").innerHTML=[
      ["Corrected",(best.corP*100).toFixed(1)+"%","var(--gn)"],
      ["Ask",(best.ask*100).toFixed(1)+"Â¢","var(--tx)"],
      ["Eff Ask",(best.effectiveAsk*100).toFixed(1)+"Â¢","var(--tx)"],
      ["Fill",(best.fillFraction*100).toFixed(0)+"%","var(--tx)"],
      ["True Edge","+"+(best.trueEdge*100).toFixed(1)+"pt","var(--gn)"],
      ["Models",best.modelVotes+"/"+(CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)),"var(--gn)"],
      ["â…“Kelly","$"+best.bet.toFixed(2),"var(--gn)"],
      ["E[Profit]","+$"+best.ev.toFixed(2),"var(--gn)"],
    ].map(([l,v,c])=>`<div class="si"><div class="si-l">${l}</div><div class="si-v" style="color:${c}">${v}</div></div>`).join("");
    renderBlockedSummary([]);
  }else if(activeRows.length>0){
    bn.style.borderColor="rgba(74,134,200,.25)";$("sigT").style.color="var(--h1)";
    $("sigT").textContent="Position already active";
    $("sigN").textContent=activeRows.map(a=>a.bracket).join(", ");
    $("sigD").innerHTML=activeRows.map(a=>`<div style="font-size:11px;color:var(--h1);margin:2px 0">${a.bracket}: already in portfolio for ${CITY.name} ${ACTIVE_DATE.displayShort}</div>`).join("");
    renderBlockedSummary([]);
  }else if(filtered.length>0){
    bn.style.borderColor="var(--bd)";$("sigT").style.color="var(--dm)";
    $("sigT").textContent=filtered.length+" signal(s) filtered by live-mode rules";
    $("sigN").textContent="NO TRADE";
    $("sigD").innerHTML=filtered.map(f=>`<div style="font-size:11px;color:var(--dm);margin:2px 0">${f.bracket}: ${(f.filterReasons||[]).join(" Â· ")}</div>`).join("");
    renderBlockedSummary(filtered);
  }else{
    bn.style.borderColor="var(--bd)";$("sigT").style.color="var(--dm)";
    $("sigT").textContent="No actionable signal";$("sigN").textContent="â€”";$("sigD").innerHTML="";
    renderBlockedSummary([]);
  }

  // Main table
  const maxMktP=A.reduce((m,a)=>Math.max(m,a.mktP||0),0);
  let h="",tB=0,tE=0;
  for(const a of A){
    const hl=a.sig==="BUY"||a.sig==="LEAN"||a.sig==="ACTIVE";
    const isF=a.sig==="FILTERED";
    const tec=a.trueEdge>.03?"var(--gn)":a.trueEdge>0?"rgba(22,163,74,.5)":a.trueEdge<-.03?"var(--rd)":"var(--dm)";
    let tg;
    if(a.sig==="BUY")tg='<span class="tb tb-b">BUY</span>';
    else if(a.sig==="LEAN")tg='<span class="tb tb-l">LEAN</span>';
    else if(a.sig==="ACTIVE")tg='<span class="tb" style="background:rgba(74,134,200,.09);color:var(--h1)">ACTIVE</span>';
    else if(isF){
      const reason=(a.filterReasons||[]).join(" Â· ");
      tg=`<span class="tb tb-blocked" title="${escAttr(reason)}">BLOCKED</span>`;
    }
    else tg='<span style="color:var(--dm);font-size:10px">â€”</span>';
    if(a.bet>0){tB+=a.bet;tE+=a.ev}
    const totalModels=CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0);
    const mvPct=totalModels>0?a.modelVotes/totalModels:0;
    const mvC=mvPct>=0.75?"var(--gn)":mvPct>=0.5?"var(--am)":"var(--rd)";
    const ft=isF&&a.filterReasons?` title="${escAttr(a.filterReasons.join("; "))}"`:"";
    const isMktFav=maxMktP>0&&Math.abs((a.mktP||0)-maxMktP)<1e-9;
    h+=`<tr class="${hl?"rh":""} ${a.isActive?"pos-w":""}"${ft}><td>${a.bracket}</td>
    <td style="text-align:center">${tg}</td>
    <td style="color:var(--dm)">${(a.rawP*100).toFixed(1)}%</td>
    <td style="color:var(--tx);font-weight:500">${(a.corP*100).toFixed(1)}%</td>
    <td style="color:var(--dm)">${isMktFav?`<span class="mfav" title="Market favorite">${(a.mktP*100).toFixed(0)}%</span>`:`${(a.mktP*100).toFixed(0)}%`}</td>
    <td style="color:var(--dm)">${a.bid.toFixed(3)}</td><td title="effective ${a.effectiveAsk.toFixed(3)}">${a.ask.toFixed(3)}</td>
    <td style="color:var(--dm)">${a.spread>0?(a.spread*100).toFixed(1)+"Â¢":"â€”"}</td>
    <td style="color:${a.rawEdge>0?"rgba(22,163,74,.5)":"var(--dm)"}">${a.rawEdge>=0?"+":""}${(a.rawEdge*100).toFixed(1)}</td>
    <td style="color:${tec};font-weight:700">${a.trueEdge>=0?"+":""}${(a.trueEdge*100).toFixed(1)}</td>
    <td style="color:${mvC};font-size:11px">${a.modelVotes}/${CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)}</td>
    <td style="color:${a.bet>0?"var(--gn)":a.isActive?"var(--h1)":"var(--dm)"}">${a.bet>0?"$"+a.bet.toFixed(2):a.isActive?"HOLD":"â€”"}</td>
    <td style="color:${a.ev>0?"var(--gn)":"var(--dm)"}">${a.ev>0?"+$"+a.ev.toFixed(2):"â€”"}</td></tr>`;
  }
  $("tbl").innerHTML=h;
  const feeLabel=(EXEC_CONFIG.feeRate*100).toFixed(2)+"%";
  $("totals").innerHTML=tB>0?
    `<span>Wagered: <b>$${tB.toFixed(2)}</b></span><span>E[Profit]: <b style="color:var(--gn)">+$${tE.toFixed(2)}</b></span><span>E[ROI]: <b style="color:var(--gn)">+${((tE/tB)*100).toFixed(0)}%</b></span><span style="color:var(--dm)">Gas est: $${gasCostUsd.toFixed(3)} | Fee: ${feeLabel}</span>`:
    (activeRows.length?`<span style="color:var(--h1)">Holding ${activeRows.length} active bracket(s) in this market; no duplicate buys.</span>`:'<span style="color:var(--dm)">No positions after analysis</span>');

  // Histogram
  const vis=B.filter(b=>(rawProbs[b]||0)>.001||(corrProbs[b]||0)>.001||(prices[b]||0)>.01);
  if(vis.length){$("histPanel").style.display="block";
    if($("logPanel"))$("logPanel").style.gridColumn="auto";
    const mxP=0.40;
    $("hist").innerHTML=vis.map(b=>{
      const rp=rawProbs[b]||0,cp=(useRaw?rp:corrProbs[b])||0,mp=prices[b]||0;
      const rH=Math.max(rp>.005?2:0,rp/mxP*100),cH=Math.max(cp>.005?2:0,cp/mxP*100),mH=Math.max(mp>.005?2:0,mp/mxP*100);
      return`<div class="hc"><div class="hp">${(cp*100).toFixed(0)}%</div><div class="hbs"><div class="hb1" style="height:${rH}%;background:var(--h1);opacity:.45"></div><div class="hb2" style="height:${cH}%;background:var(--h2);opacity:.7"></div><div class="hb3" style="height:${mH}%;background:rgba(26,26,46,.15)"></div></div><div class="hl">${bracketShortLabel(b)}</div></div>`;
    }).join("");
  }else{
    $("histPanel").style.display="none";
    if($("logPanel"))$("logPanel").style.gridColumn="1 / -1";
  }

  updateCityClock();

  // Entry timing (live mode)
  const et=$("entryTiming");
  if(LIVE_MODE){
    et.style.display="block";
    let msg="",col="",bg="";
    if(!lateApplies){
      msg=`Late guard inactive for this date (local ${localDateNow}).`;
      col="var(--dm)";bg="rgba(39,39,42,.04)";
    }else if(latePhase==="normal"){
      msg=`Normal window (${CITY.tz}) â€” cutoff ${cutoffHour}:00 local.`;
      col="var(--gn)";bg="rgba(22,163,74,.04)";
    }else if(latePhase==="after_cutoff"){
      msg=`Late window (${CITY.tz}) â€” only favorite bracket allowed after ${cutoffHour}:00.`;
      col="var(--am)";bg="rgba(180,83,9,.06)";
    }else{
      msg=`Freeze window (${CITY.tz}) â€” no new entries after ${freezeHour}:00 local.`;
      col="var(--rd)";bg="rgba(220,38,38,.04)";
    }
    if(lateApplies&&metarDayMax!=null){
      msg+=` Observed high: ${metarDayMax}${unitLabel()}.`;
    }
    et.style.color=col;et.style.borderColor=col;et.style.background=bg;et.textContent=msg;
  }else{et.style.display="none"}
  $("stopLossWarn").style.display="none";
  updateActivePositionNotice();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _marketsDiscovered=false;
async function refresh(){
  $("badge").textContent="Refreshing...";
  await refreshSummary(false);
  if(!API_CONNECTED){
    log("Dashboard API offline â€” cannot refresh snapshot","le");
    cd=RS;
    return;
  }
  if(!_marketsDiscovered){
    try{await Promise.race([discoverMarkets(),new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),10000))])}
    catch(e){
      log("Market discovery failed ("+e.message+"), using known dates","lw");
      const today=new Date();today.setUTCHours(12,0,0,0);
      const todayStr=today.toISOString().split("T")[0];
      const yd=new Date(today);yd.setUTCDate(yd.getUTCDate()-1);
      const tm=new Date(today);tm.setUTCDate(tm.getUTCDate()+1);
      ALL_DATES=[yd,today,tm].map(d=>buildDateConfig(d.toISOString().split("T")[0]));
      ACTIVE_DATE=buildDateConfig(todayStr);
    }
    _marketsDiscovered=true;renderDateTabs();
  }
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span>Â· "+ACTIVE_DATE.display+"</span>";
  await fetchDashboardSnapshot();
  render();cd=RS;
}

// INIT
initBotSwitchFromCache();
loadApiSettingsToInputs();
setApiConnected(false);
updateActivePositionNotice();
refreshSummary(false);
refreshLiveLogs();
renderCityNav();
selectCity("london"); // default
setInterval(()=>{cd--;$("badge").textContent="Auto-refresh "+cd+"s";updateCityClock();if(cd<=0)refresh()},1000);
setInterval(()=>refreshSummary(false),15000);
setInterval(()=>refreshLiveLogs(),10000);
</script>
</body>
</html>
