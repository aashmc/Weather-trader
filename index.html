<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Weather Trader</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap');
:root{--bg:#ffffff;--sf:#f8f8fa;--sf2:#f0f0f4;--bd:#e4e4e8;--tx:#1a1a2e;--dm:#8888a0;--dm2:#a0a0b4;--gn:#16a34a;--gn2:rgba(22,163,74,.05);--rd:#dc2626;--rd2:rgba(220,38,38,.05);--am:#b45309;--h1:#4a86c8;--h2:#16a34a;--h3:rgba(26,26,46,.1)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,sans-serif;min-height:100vh;display:flex}
.sidebar{width:180px;min-height:100vh;background:var(--sf);border-right:1px solid var(--bd);padding:16px 0;flex-shrink:0;position:sticky;top:0;height:100vh}
.sb-title{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--dm2);padding:0 14px;margin-bottom:10px}
.sb-item{display:flex;align-items:center;gap:8px;padding:8px 14px;cursor:pointer;font-size:13px;font-weight:500;color:var(--dm);transition:all .15s;border-left:2px solid transparent}
.sb-item:hover{color:var(--tx);background:var(--sf2)}
.sb-item.active{color:var(--tx);background:var(--sf2);border-left-color:var(--tx)}
.sb-flag{font-size:14px}
.sb-meta{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm2);margin-top:1px}
.main{flex:1;padding:20px 24px;max-width:none}
.hdr{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:1px solid var(--bd);padding-bottom:12px;margin-bottom:14px}
.hdr h1{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;letter-spacing:2px;color:var(--dm);text-transform:uppercase;margin-bottom:4px}
.hdr h2{font-size:36px;font-weight:600;color:var(--tx)}.hdr h2 span{color:var(--dm2);font-weight:400}
.hr{text-align:right;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm2);line-height:2}
.lb{display:inline-flex;align-items:center;gap:5px;color:var(--dm);font-weight:500}
.lb::before{content:'';width:5px;height:5px;background:var(--gn);border-radius:50%;animation:p 2s infinite}
@keyframes p{0%,100%{opacity:1}50%{opacity:.15}}
.warn{background:var(--sf);border:1px solid var(--bd);border-radius:6px;padding:8px 12px;margin-bottom:12px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm);line-height:1.5}
.warn b{color:var(--tx)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:12px}
.st{background:var(--sf);border:1px solid var(--bd);border-radius:6px;padding:10px 12px}
.st-l{font-family:'IBM Plex Mono',monospace;font-size:8px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--dm2);margin-bottom:3px}
.st-v{font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:600;color:var(--tx)}
.st-s{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm2);margin-top:2px}
.sb-sig{border-radius:6px;padding:10px 14px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;background:var(--sf);border:1px solid var(--bd)}
.sg-t{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:500;letter-spacing:1.5px;text-transform:uppercase;color:var(--dm);margin-bottom:2px}
.sg-n{font-size:20px;font-weight:600}
.sg-d{display:flex;gap:14px;flex-wrap:wrap}
.si{text-align:right}.si-l{font-family:'IBM Plex Mono',monospace;font-size:8px;text-transform:uppercase;letter-spacing:1.5px;color:var(--dm2);margin-bottom:1px}
.si-v{font-family:'IBM Plex Mono',monospace;font-size:14px;font-weight:600}
.pn{background:var(--sf);border:1px solid var(--bd);border-radius:6px;padding:12px;margin-bottom:10px}
.pt{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:var(--dm2);margin-bottom:8px}
table{width:100%;border-collapse:collapse}
th{font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--dm2);padding:0 3px 6px;text-align:right;border-bottom:1px solid var(--bd)}
th:first-child{text-align:left}
td{font-family:'IBM Plex Mono',monospace;font-size:11px;padding:6px 3px;text-align:right;border-bottom:1px solid var(--bd);color:var(--dm)}
td:first-child{text-align:left;font-weight:500;color:var(--tx)}
.tb{display:inline-block;font-size:8px;font-weight:600;padding:2px 6px;border-radius:3px;letter-spacing:.5px}
.tb-b{background:var(--gn2);color:var(--gn)}.tb-s{background:var(--rd2);color:var(--rd)}.tb-l{background:rgba(22,163,74,.03);color:var(--gn);opacity:.6}
.rh{background:rgba(22,163,74,.02)}
.tb-blocked{background:rgba(255,152,0,.08);color:#ff9800;cursor:help}
.mfav{display:inline-block;padding:1px 6px;border-radius:999px;background:rgba(74,134,200,.12);color:var(--h1);font-weight:700}
.hist{display:flex;align-items:flex-end;gap:4px;height:100px;margin:6px 0}
.hc{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:100%}
.hbs{display:flex;gap:2px;align-items:flex-end;width:100%;justify-content:center;flex:1}
.hb1,.hb2,.hb3{width:28%;border-radius:2px 2px 0 0;transition:height .5s}
.hp{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm2);margin-bottom:2px}
.hl{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm2);margin-top:4px}
.tot{margin-top:8px;padding-top:8px;border-top:1px solid var(--bd);display:flex;gap:18px;font-family:'IBM Plex Mono',monospace;font-size:11px;flex-wrap:wrap}
#log{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm);max-height:180px;overflow-y:auto;padding:2px 0;line-height:1.7}
.lo{color:var(--dm)}.le{color:var(--rd)}.lw{color:var(--am)}
.ft{margin-top:8px;font-size:9px;color:var(--dm2);line-height:1.6;font-family:'IBM Plex Mono',monospace}
.ft a{color:var(--h1);text-decoration:underline;text-underline-offset:2px}
.pnl-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:6px;margin-bottom:10px;font-family:'IBM Plex Mono',monospace;font-size:10px}
.pnl-wait{background:var(--sf);border:1px solid var(--bd);color:var(--dm)}
.pnl-live{background:var(--sf);border:1px solid var(--bd);color:var(--tx)}
.pnl-win{background:rgba(22,163,74,.03);border:1px solid rgba(22,163,74,.12);color:var(--gn)}
.pnl-lose{background:rgba(220,38,38,.03);border:1px solid rgba(220,38,38,.12);color:var(--rd)}
.pnl-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.pnl-big{text-align:center;padding:12px;font-family:'IBM Plex Mono',monospace;margin-bottom:6px}
.pnl-big-label{font-size:8px;text-transform:uppercase;letter-spacing:2px;color:var(--dm2);margin-bottom:3px}
.pnl-big-val{font-size:22px;font-weight:600}
.pnl-big-sub{font-size:8px;color:var(--dm2);margin-top:3px}
.pos-w{background:rgba(22,163,74,.02)}.pos-l{opacity:.35}
@media(max-width:700px){.stats{grid-template-columns:repeat(2,1fr)}.sidebar{display:none}.main{padding:12px}.hdr h2{font-size:24px}}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:5px 10px;border-radius:999px;border:1px solid var(--bd);background:var(--sf);font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm)}
.chip b{color:var(--tx);font-weight:600}
.chip-live{border-color:rgba(22,163,74,.2);background:rgba(22,163,74,.04);color:var(--gn)}
.chip-pause{border-color:rgba(220,38,38,.2);background:rgba(220,38,38,.04);color:var(--rd)}
.chip-info{border-color:rgba(74,134,200,.25);background:rgba(74,134,200,.07);color:var(--h1)}
.ctl{display:flex;align-items:center;gap:8px}
.sw{display:inline-flex;align-items:center;gap:8px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dm)}
.sw input{display:none}
.sw span{position:relative;width:34px;height:18px;border-radius:999px;background:var(--bd);display:inline-block;transition:.2s}
.sw span::after{content:'';position:absolute;left:2px;top:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:.2s}
.sw input:checked + span{background:var(--gn)}
.sw input:checked + span::after{left:18px}
.api-grid{display:grid;grid-template-columns:repeat(3,minmax(160px,1fr));gap:8px}
.cfg-grid-min{display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:8px}
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm2);text-transform:uppercase;letter-spacing:1px}
.field input{font-family:'IBM Plex Mono',monospace;font-size:11px;padding:6px 8px;border:1px solid var(--bd);border-radius:4px;background:#fff;color:var(--tx)}
.btn{padding:6px 12px;border-radius:4px;border:1px solid var(--bd);background:var(--sf);color:var(--tx);cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:10px}
.btn-primary{border-color:rgba(22,163,74,.35);background:rgba(22,163,74,.08);color:var(--gn)}
.note-active{margin-bottom:10px;border-color:rgba(74,134,200,.35);background:rgba(74,134,200,.06);color:var(--h1)}
.cfg-grid{display:flex;flex-direction:column;gap:0}
.cfg-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--bd);gap:12px}
.cfg-row:last-child{border-bottom:none}
.cfg-l{display:flex;flex-direction:column;gap:1px;flex:1}
.cfg-name{font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;color:var(--tx)}
.cfg-desc{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--dm2);line-height:1.3}
.cfg-val{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:500}
.cfg-input{font-family:'IBM Plex Mono',monospace;font-size:10px;padding:3px 8px;border:1px solid var(--bd);border-radius:3px;background:var(--sf);color:var(--tx);text-align:right;width:90px}
.cfg-input:focus{outline:none;border-color:var(--dm2)}
.cfg-city{padding:10px 0;border-bottom:1px solid var(--bd)}
.cfg-city:last-child{border-bottom:none}
.cfg-city-hdr{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.cfg-city-flag{font-size:14px}
.cfg-city-name{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600}
.cfg-city-meta{font-family:'IBM Plex Mono',monospace;font-size:8px;color:var(--dm2)}
.cfg-city-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px 16px;margin-left:22px}
.cfg-city-item{display:flex;justify-content:space-between;align-items:center;font-family:'IBM Plex Mono',monospace;font-size:9px;padding:2px 0}
.cfg-city-item span:first-child{color:var(--dm)}
.cfg-city-item span:last-child{color:var(--tx);font-weight:500}
.dtabs{display:flex;gap:3px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.dtab{padding:5px 12px;border-radius:4px;border:1px solid var(--bd);background:transparent;color:var(--dm);cursor:pointer;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;white-space:nowrap;transition:all .15s}
.dtab:hover{color:var(--tx)}
.dtab.active{background:var(--sf2);border-color:var(--dm2);color:var(--tx)}
.dtab .dtag{font-size:7px;padding:1px 3px;border-radius:2px;margin-left:4px;font-weight:600;letter-spacing:.5px}
.dtab .dtag-today{background:rgba(22,163,74,.08);color:var(--gn)}
.dtab .dtag-past{background:rgba(0,0,0,.06);color:var(--dm)}
.dtab .dtag-future{background:rgba(0,0,0,.04);color:var(--dm)}
</style>
</head>
<body>

<div class="sidebar">
<div class="sb-title">Markets</div>
<div id="cityNav"></div>
</div>

<div class="main" id="tradingPage">
<div class="hdr">
<div><h1>Weather Trader</h1><h2 id="hdrTitle">Loading... <span></span></h2></div>
<div class="hr">
  <div class="ctl" style="justify-content:flex-end;margin-bottom:4px">
    <label class="sw" title="Pause/resume live trading bot">
      <input id="botSwitch" type="checkbox" onchange="toggleBotPause()">
      <span></span>
      <em id="botSwitchLabel" style="font-style:normal">Bot ON</em>
    </label>
  </div>
  <div class="lb" id="badge">Starting...</div><br><span id="stationInfo">â€”</span><br><span id="ut">â€”</span>
</div>
</div>

<div class="chips">
  <div class="chip chip-live" id="chipBankroll">Bankroll: <b>â€”</b></div>
  <div class="chip" id="chipExposure">Exposure: <b>â€”</b></div>
  <div class="chip" id="chipActive">Active positions: <b>0</b></div>
  <div class="chip" id="chipMode">Mode: <b>â€”</b></div>
  <div class="chip" id="chipApi">API: <b>offline</b></div>
</div>
<div class="warn note-active" id="activePosNotice" style="display:none"></div>

<div class="dtabs" id="dateTabs"></div>

<div class="warn" id="biasWarn"></div>

<div class="stats">
<div class="st"><div class="st-l">METAR Live</div><div class="st-v" id="curT">â€”</div><div class="st-s" id="curTs">â€”</div></div>
<div class="st"><div class="st-l">Day High (METAR)</div><div class="st-v" id="dH">â€”</div><div class="st-s" id="dHs">â€”</div></div>
<div class="st"><div class="st-l">Ensemble Mean</div><div class="st-v" id="ensMean">â€”</div><div class="st-s" id="ensSrc">loading...</div></div>
<div class="st"><div class="st-l">Execution</div><div class="st-v">LIVE</div><div class="st-s">strict filters enabled</div></div>
</div>

<div id="entryTiming" style="display:none;padding:8px 14px;border-radius:6px;margin-bottom:8px;font-size:11px;border:1px solid var(--dm)"></div>
<div id="stopLossWarn" style="display:none;padding:10px 14px;border-radius:6px;margin-bottom:8px;font-size:12px;font-weight:700;border:1px solid var(--rd);background:rgba(220,38,38,.04);color:var(--rd)"></div>

<div class="sb-sig" id="sigB">
<div><div class="sg-t" id="sigT" style="color:var(--dm)">Connecting...</div><div class="sg-n" id="sigN">â€”</div></div>
<div class="sg-d" id="sigD"></div>
</div>

<div class="pn">
<div class="pt">Bracket Analysis â€” Bias-Corrected True Edge After All Costs</div>
<table><thead><tr>
<th style="text-align:left">Bracket</th><th style="text-align:center">Signal</th>
<th>Raw %</th><th>Corrected %</th><th>Market %</th><th>Bid</th><th>Ask</th><th>Spread</th>
<th>Raw Edge</th><th style="color:var(--gn)">True Edge</th><th>Models</th><th>Bet</th><th>E[P]</th>
</tr></thead><tbody id="tbl"></tbody></table>
<div class="tot" id="totals"></div>
</div>

<div class="pn" id="histPanel" style="display:none">
<div class="pt">Distribution: Raw â†’ Corrected â†’ Market</div>
<div class="hist" id="hist"></div>
<div style="display:flex;gap:14px;margin-top:6px;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm)"><span style="color:var(--h1)">â—¼ Raw</span><span style="color:var(--h2)">â—¼ Corrected</span><span style="opacity:.35">â—¼ Market</span></div>
</div>

<div class="pn"><div class="pt">Log</div><div id="log"></div></div>

<div class="pn">
<div class="pt">Live Control</div>
<div class="api-grid">
  <div class="field">
    <label>API Base URL</label>
    <input id="apiBase" placeholder="http://178.62.253.211:8090">
  </div>
  <div class="field">
    <label>API Token</label>
    <input id="apiToken" type="password" placeholder="x-api-key">
  </div>
  <div class="field">
    <label>Actions</label>
    <div style="display:flex;gap:6px">
      <button class="btn" onclick="saveApiSettings()">Save</button>
      <button class="btn btn-primary" onclick="refreshSummary(true)">Connect</button>
    </div>
  </div>
</div>
<div id="apiMsg" style="margin-top:8px;font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm)"></div>
</div>

<div class="pn">
<div class="pt">Risk Parameters (Live Bot)</div>
<div class="cfg-grid-min">
  <div class="field"><label>Max Bet Ratio</label><input id="cfgMaxBetRatio" type="number" step="0.01" min="0" max="1"></div>
  <div class="field"><label>Max Exposure Ratio</label><input id="cfgMaxExposureRatio" type="number" step="0.01" min="0" max="1"></div>
  <div class="field"><label>Daily Loss Ratio</label><input id="cfgDailyLossRatio" type="number" step="0.01" min="0" max="1"></div>
  <div class="field"><label>Min Ask Depth</label><input id="cfgMinAskDepth" type="number" step="1" min="0"></div>
  <div class="field"><label>Max Ask Price</label><input id="cfgMaxAskPrice" type="number" step="0.01" min="0" max="1"></div>
  <div class="field"><label>Order Timeout (sec)</label><input id="cfgOrderTimeout" type="number" step="1" min="30"></div>
  <div class="field"><label>City Min Edge</label><input id="cfgCityMinEdge" type="number" step="0.01" min="0" max="0.5"></div>
  <div class="field"><label>City Min Models</label><input id="cfgCityMinModels" type="number" step="1" min="1"></div>
  <div class="field"><label>City Min Families</label><input id="cfgCityMinFamilies" type="number" step="1" min="1"></div>
</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:10px">
  <button class="btn btn-primary" onclick="saveRuntimeConfig()">Save Live Config</button>
  <span id="cfgMsg" style="font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--dm)"></span>
</div>
</div>

<div class="ft" id="footer">â€”</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITY CONFIGURATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CITIES={
  london:{
    name:"London",flag:"ğŸ‡¬ğŸ‡§",icao:"EGLC",lat:51.5053,lon:0.0553,
    unit:"C",stationName:"London City Airport",
    polyCity:"london",tz:"Europe/London",
    wunderground:"https://www.wunderground.com/history/daily/gb/london/EGLC",
    // 176 members: ICON(39)+ECMWF IFS(50)+ECMWF AIFS(50)+GEM(20)+UKMO(17)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble,ecmwf_aifs025_ensemble,gem_global_ensemble,ukmo_global_ensemble_20km",
    syntheticModel:null,
    bias:{mean:0.17,sd:0.66,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  seoul:{
    name:"Seoul",flag:"ğŸ‡°ğŸ‡·",icao:"RKSI",lat:37.4602,lon:126.4407,
    unit:"C",stationName:"Incheon Intl Airport",
    polyCity:"seoul",tz:"Asia/Seoul",
    wunderground:"https://www.wunderground.com/history/daily/kr/incheon/RKSI",
    // 120 ensemble + 10 KMA synthetic = ~130 members
    // Dropped: ICON(1.7 RMSE), UKMO(2.8 RMSE), GFS(2.4), JMA(2.2)
    ensembleModels:"ecmwf_ifs025_ensemble,ecmwf_aifs025_ensemble,gem_global_ensemble",
    syntheticModel:"kma_seamless", // Korea's own model, best for Seoul (0.9 RMSE) but no ensemble
    bias:{mean:0.69,sd:0.86,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  nyc:{
    name:"NYC",flag:"ğŸ‡ºğŸ‡¸",icao:"KLGA",lat:40.7772,lon:-73.8726,
    unit:"F",stationName:"LaGuardia Airport",
    polyCity:"nyc",tz:"America/New_York",
    wunderground:"https://www.wunderground.com/history/daily/us/ny/new-york-city/KLGA",
    // 89 members: ICON(39)+ECMWF IFS(50). ECMWF has +2.8F bias, corrected via MC
    // Dropped: GEM(4.0 RMSE), JMA(4.6), UKMO(2.7)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble",
    syntheticModel:null,
    bias:{mean:1.79,sd:2.49,note:"45-day METAR backtest Jan-Feb 2026"},
  },
  seattle:{
    name:"Seattle",flag:"ğŸ‡ºğŸ‡¸",icao:"KSEA",lat:47.4502,lon:-122.3088,
    unit:"F",stationName:"Seattle-Tacoma Intl",
    polyCity:"seattle",tz:"America/Los_Angeles",
    wunderground:"https://www.wunderground.com/history/daily/us/wa/seatac/KSEA",
    // 109 members: ICON(39)+ECMWF IFS(50)+GEM(20). All ~same bias, consistent correction
    // Dropped: UKMO(2.9 RMSE), JMA(2.6)
    ensembleModels:"icon_seamless_eps,ecmwf_ifs025_ensemble,gem_global_ensemble",
    syntheticModel:null,
    bias:{mean:1.66,sd:1.93,note:"45-day METAR backtest Jan-Feb 2026"},
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CITY=CITIES.london; // active city
let B=[]; // bracket labels â€” populated dynamically from Polymarket
let TOKENS={};
const KELLY_FRAC=0.30,RS=60;
const LIVE_MODE=true,BR=25;
const FILTERS={minEdge:0.05,minDepth:20,maxAsk:0.50,minModels:2,bankroll:25};
const CITY_FILTERS={
  london:{minEdge:0.05,minModels:3,maxAsk:0.50},
  seoul:{minEdge:0.05,minModels:3,maxAsk:0.50},
  nyc:{minEdge:0.08,minModels:2,maxAsk:0.50},
  seattle:{minEdge:0.05,minModels:2,maxAsk:0.50},
};
const LATE_GUARD_CONFIG={
  enabled:true,
  defaultCutoffHour:15,
  cutoffByCity:{london:15,seoul:15,nyc:16,seattle:16},
  freezeHoursAfterCutoff:6,
  favoriteOnlyAfterCutoff:true,
  minEdgeAfterCutoff:0.08,
  freezeAllNewEntries:true,
};
function F(){return {...FILTERS,...(CITY_FILTERS[CITY.polyCity]||{})}}

let prices={},books={},rawProbs={},corrProbs={},ensMean=0,ensCount=0;
let gasCostUsd=0.03,polPrice=0.35,metarTemp=null,metarHigh=null,metarDayMax=null;
let cd=RS,pxi=0;
const EXEC_CONFIG={
  enabled:true,
  feeRate:0.0,             // weather markets are usually fee-free
  gasUsdPerOrder:0.0,      // keep 0 to match bot defaults
  useLiveGasEstimate:false, // optional: use gasCostUsd estimate
  spreadRef:0.04,          // 4c spread reference
  queuePenalty:0.50,
  minFill:0.05,
  maxFill:0.98
};

const $=id=>document.getElementById(id);
function log(m,c=""){const el=$("log"),t=new Date().toLocaleTimeString();el.innerHTML=`<div class="${c}">[${t}] ${m}</div>`+el.innerHTML;while(el.children.length>40)el.removeChild(el.lastChild)}

const PX=[u=>"https://api.allorigins.win/raw?"+new URLSearchParams({url:u}),u=>"https://corsproxy.io/?"+encodeURIComponent(u),u=>u];
let API_BASE=localStorage.getItem("wt_api_base")||"";
let API_TOKEN=localStorage.getItem("wt_api_token")||"";
let ACTIVE_MARKET_BRACKETS={};
let BOT_PAUSED=false;
let RUNTIME_EFFECTIVE={};
let API_CONNECTED=false;

function uniq(arr){return [...new Set(arr.filter(Boolean))]}
function escAttr(v){return String(v??"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}

function apiBaseCandidates(){
  const sameOrigin=location.origin?.startsWith("http")?location.origin:"";
  const host8090=(location.hostname&&location.hostname!=="localhost"&&location.hostname!=="127.0.0.1")
    ?`${location.protocol==="https:"?"https":"http"}://${location.hostname}:8090`
    :"";
  return uniq([API_BASE,sameOrigin,host8090,"http://178.62.253.211:8090"]);
}

function setApiMsg(msg,isErr=false){
  const el=$("apiMsg");if(!el)return;
  el.textContent=msg||"";
  el.style.color=isErr?"var(--rd)":"var(--dm)";
}

function updateTopChips(summary){
  const cash=summary?.bankroll?.cash;
  const exp=summary?.portfolio?.active_exposure;
  const active=summary?.portfolio?.active_positions;
  const key=`${cityDisplayName(CITY.name)}:${ACTIVE_DATE.dateStr}`;
  const currentMarketActive=(summary?.active_by_market?.[key]||[]).length;
  const mode=summary?.control?.mode||"manual";
  BOT_PAUSED=!!summary?.control?.paused;
  $("chipBankroll").innerHTML=`Bankroll: <b>${cash>=0?`$${Number(cash).toFixed(2)}`:"â€”"}</b>`;
  $("chipExposure").innerHTML=`Exposure: <b>${typeof exp==="number"?`$${exp.toFixed(2)}`:"â€”"}</b>`;
  $("chipActive").innerHTML=`Active positions: <b>${Number(active||0)}</b>${currentMarketActive?` Â· this market <b>${currentMarketActive}</b>`:""}`;
  $("chipMode").innerHTML=`Mode: <b>${mode}${BOT_PAUSED?" Â· paused":""}</b>`;
  $("chipMode").className=`chip ${BOT_PAUSED?"chip-pause":"chip-live"}`;
  setBotSwitchUi(BOT_PAUSED);
}

function setApiConnected(ok){
  API_CONNECTED=!!ok;
  const el=$("chipApi");
  el.innerHTML=`API: <b>${ok?"connected":"offline"}</b>`;
  el.className=`chip ${ok?"chip-live":"chip-pause"}`;
  el.title=ok
    ?"Connected to live bot API."
    :"API offline means dashboard cannot reach live bot backend, so bankroll/exposure/active positions cannot update.";
}

function setBotSwitchUi(paused){
  const sw=$("botSwitch"),lbl=$("botSwitchLabel");
  if(!sw||!lbl)return;
  sw.checked=!paused;
  lbl.textContent=paused?"Bot OFF":"Bot ON";
  localStorage.setItem("wt_last_bot_paused",paused?"1":"0");
}

function initBotSwitchFromCache(){
  const v=localStorage.getItem("wt_last_bot_paused");
  setBotSwitchUi(v==="1");
}

function loadCachedSummary(){
  try{
    const raw=localStorage.getItem("wt_last_summary");
    if(!raw)return false;
    const s=JSON.parse(raw);
    ACTIVE_MARKET_BRACKETS=s.active_by_market||{};
    RUNTIME_EFFECTIVE=s.runtime_effective||{};
    updateTopChips(s);
    fillConfigInputs(RUNTIME_EFFECTIVE);
    updateActivePositionNotice();
    setApiMsg("Showing last known live values. API offline right now.",true);
    return true;
  }catch(e){
    return false;
  }
}

function cityDisplayName(key){
  if(key==="NYC")return "NYC";
  return key;
}

function activeBracketSetForCurrentMarket(){
  const k=`${cityDisplayName(CITY.name)}:${ACTIVE_DATE.dateStr}`;
  return new Set(ACTIVE_MARKET_BRACKETS[k]||[]);
}

function updateActivePositionNotice(){
  const list=Array.from(activeBracketSetForCurrentMarket());
  const el=$("activePosNotice");
  if(!el)return;
  if(!list.length){
    el.style.display="none";
    return;
  }
  el.style.display="block";
  el.innerHTML=`Active in this market: <b>${list.join(", ")}</b>. Duplicate BUY on same bracket is blocked.`;
}

function authHeaders(){
  const h={"Content-Type":"application/json"};
  if(API_TOKEN)h["X-API-Key"]=API_TOKEN;
  return h;
}

async function apiGet(path){
  if(!API_BASE)throw new Error("API base URL not set");
  const r=await fetch(`${API_BASE}${path}`,{headers:authHeaders(),signal:AbortSignal.timeout(8000)});
  if(!r.ok)throw new Error(`HTTP ${r.status}`);
  const j=await r.json();
  if(!j.ok)throw new Error(j.error||"API error");
  return j.data;
}

async function apiPost(path,payload){
  if(!API_BASE)throw new Error("API base URL not set");
  const r=await fetch(`${API_BASE}${path}`,{
    method:"POST",
    headers:authHeaders(),
    body:JSON.stringify(payload||{}),
    signal:AbortSignal.timeout(8000),
  });
  if(!r.ok)throw new Error(`HTTP ${r.status}`);
  const j=await r.json();
  if(!j.ok)throw new Error(j.error||"API error");
  return j.data;
}

function loadApiSettingsToInputs(){
  if(!API_BASE){
    const cands=apiBaseCandidates();
    API_BASE=cands.find(v=>v!==location.origin)||cands[0]||"";
  }
  if($("apiBase"))$("apiBase").value=API_BASE;
  if($("apiToken"))$("apiToken").value=API_TOKEN;
}

function saveApiSettings(){
  API_BASE=($("apiBase").value||"").trim().replace(/\/$/,"");
  API_TOKEN=($("apiToken").value||"").trim();
  localStorage.setItem("wt_api_base",API_BASE);
  localStorage.setItem("wt_api_token",API_TOKEN);
  setApiMsg("Saved API settings.");
  refreshSummary(true);
}

function fillConfigInputs(eff){
  if(!eff)return;
  $("cfgMaxBetRatio").value=eff.max_bet_ratio ?? "";
  $("cfgMaxExposureRatio").value=eff.max_exposure_ratio ?? "";
  $("cfgDailyLossRatio").value=eff.daily_loss_ratio ?? "";
  $("cfgMinAskDepth").value=eff.min_ask_depth ?? "";
  $("cfgMaxAskPrice").value=eff.max_ask_price ?? "";
  $("cfgOrderTimeout").value=eff.order_timeout_seconds ?? "";
  const cityCfg=(eff.city_thresholds||{})[CITY.polyCity]||{};
  $("cfgCityMinEdge").value=cityCfg.min_edge ?? "";
  $("cfgCityMinModels").value=cityCfg.min_models ?? "";
  $("cfgCityMinFamilies").value=cityCfg.min_families ?? "";
}

async function refreshSummary(manual=false){
  const bases=apiBaseCandidates();
  let lastErr="unknown";
  for(const base of bases){
    try{
      API_BASE=(base||"").replace(/\/$/,"");
      if(!API_BASE)continue;
      const s=await apiGet("/api/summary");
      localStorage.setItem("wt_api_base",API_BASE);
      localStorage.setItem("wt_last_summary",JSON.stringify(s));
    ACTIVE_MARKET_BRACKETS=s.active_by_market||{};
    RUNTIME_EFFECTIVE=s.runtime_effective||{};
    updateTopChips(s);
    fillConfigInputs(RUNTIME_EFFECTIVE);
    updateActivePositionNotice();
    if(B.length&&Object.keys(prices).length)render();
    setApiConnected(true);
      if(manual)setApiMsg(`Connected to live bot API (${API_BASE}).`);
      return;
    }catch(e){
      lastErr=e.message;
    }
  }
  setApiConnected(false);
  updateActivePositionNotice();
  const hasCached=loadCachedSummary();
  if(manual){
    setApiMsg(`API offline: ${lastErr}. Check API base URL and VPS port/API service.`,true);
  }else if(!hasCached){
    setApiMsg("API offline. Fill API base URL in Live Control and click Connect.",true);
  }
}

async function saveRuntimeConfig(){
  try{
    const payload={};
    const f=(id)=>{const n=parseFloat($(id).value);return Number.isFinite(n)?n:null};
    const i=(id)=>{const n=parseInt($(id).value,10);return Number.isFinite(n)?n:null};
    const put=(k,v)=>{if(v!==null)payload[k]=v};
    put("max_bet_ratio",f("cfgMaxBetRatio"));
    put("max_exposure_ratio",f("cfgMaxExposureRatio"));
    put("daily_loss_ratio",f("cfgDailyLossRatio"));
    put("min_ask_depth",i("cfgMinAskDepth"));
    put("max_ask_price",f("cfgMaxAskPrice"));
    put("order_timeout_seconds",i("cfgOrderTimeout"));
    const cityOverride={};
    const cEdge=f("cfgCityMinEdge");
    const cModels=i("cfgCityMinModels");
    const cFamilies=i("cfgCityMinFamilies");
    if(cEdge!==null)cityOverride.min_edge=cEdge;
    if(cModels!==null)cityOverride.min_models=cModels;
    if(cFamilies!==null)cityOverride.min_families=cFamilies;
    if(Object.keys(cityOverride).length)payload.city_overrides={[CITY.polyCity]:cityOverride};
    const d=await apiPost("/api/config",payload);
    RUNTIME_EFFECTIVE=d.effective||{};
    fillConfigInputs(RUNTIME_EFFECTIVE);
    $("cfgMsg").textContent="Saved to live bot.";
    $("cfgMsg").style.color="var(--gn)";
    await refreshSummary(false);
  }catch(e){
    $("cfgMsg").textContent=`Save failed: ${e.message}`;
    $("cfgMsg").style.color="var(--rd)";
  }
}

async function toggleBotPause(){
  const sw=$("botSwitch");
  const targetPaused=!sw.checked;
  if(!API_CONNECTED){
    sw.checked=!targetPaused;
    setApiMsg("API offline: cannot change bot ON/OFF right now.",true);
    return;
  }
  try{
    await apiPost("/api/bot/pause",{paused:targetPaused});
    BOT_PAUSED=targetPaused;
    setBotSwitchUi(BOT_PAUSED);
    setApiMsg(BOT_PAUSED?"Bot paused from dashboard.":"Bot resumed from dashboard.");
    await refreshSummary(false);
  }catch(e){
    sw.checked=!targetPaused;
    setApiMsg(`Bot switch failed: ${e.message}`,true);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIT HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cToF(c){return c*9/5+32}
function fToC(f){return(f-32)*5/9}
function ensToMarket(tempC){return CITY.unit==="F"?cToF(tempC):tempC}
function unitLabel(){return"Â°"+CITY.unit}
function clip(x,lo,hi){return Math.max(lo,Math.min(hi,x))}
function localDateInTZ(tz){return new Date().toLocaleDateString("en-CA",{timeZone:tz})}
function localHourInTZ(tz){
  const parts=new Intl.DateTimeFormat("en-GB",{timeZone:tz,hour12:false,hour:"2-digit",minute:"2-digit"}).formatToParts(new Date());
  const hh=parseInt((parts.find(p=>p.type==="hour")||{}).value||"0",10);
  const mm=parseInt((parts.find(p=>p.type==="minute")||{}).value||"0",10);
  return hh+mm/60;
}

function topAskDepth(book,ask){
  if(!book||!book.asks)return 0;
  let d=0;
  for(const lvl of book.asks){
    const px=parseFloat(lvl.price||0),sz=parseFloat(lvl.size||0);
    if(Math.abs(px-ask)<=1e-9)d+=Math.max(0,sz);
    else if(px>ask)break;
  }
  return d;
}

function estimateExecution(book,ask,contracts){
  if(!book||contracts<=0){
    return{
      topAskDepth:0,immediateFillFraction:1,continuationFillProb:1,fillFraction:1,slippagePenalty:0
    };
  }
  const spread=Math.max(0,book.spd||0),askDepth=Math.max(0,book.askD||0),topDepth=topAskDepth(book,ask);
  const immediate=clip(topDepth/Math.max(1,contracts),0,1);
  const spreadRef=Math.max(0.0001,EXEC_CONFIG.spreadRef);
  const spreadScore=clip(1-(spread/spreadRef),0,1);
  const depthScore=clip(askDepth/Math.max(1,contracts),0,1);
  const qPenalty=clip((spread/spreadRef)*EXEC_CONFIG.queuePenalty,0,0.8);
  const continuation=clip(0.10+0.55*spreadScore+0.35*depthScore-qPenalty,EXEC_CONFIG.minFill,EXEC_CONFIG.maxFill);
  const fill=immediate+(1-immediate)*continuation;
  const slip=spread*(1-immediate)*0.50;
  return{
    topAskDepth:topDepth,
    immediateFillFraction:immediate,
    continuationFillProb:continuation,
    fillFraction:clip(fill,EXEC_CONFIG.minFill,1),
    slippagePenalty:Math.max(0,slip),
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DYNAMIC BRACKET PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseBracket(label){
  // Returns {type,low,high,val,unit} for matching temps to brackets
  const isF=label.includes("Â°F"),u=isF?"F":"C";
  if(label.includes("or below")||label.includes("or less")){
    const m=label.match(/([-\d]+)/);return{type:"below",high:parseInt(m[1]),unit:u}}
  if(label.includes("or higher")||label.includes("or above")){
    const m=label.match(/([-\d]+)/);return{type:"above",low:parseInt(m[1]),unit:u}}
  const rm=label.match(/([-\d]+)[\s]*[-â€“][\s]*([-\d]+)/);
  if(rm)return{type:"range",low:parseInt(rm[1]),high:parseInt(rm[2]),unit:u};
  const sm=label.match(/([-\d]+)/);
  if(sm)return{type:"single",val:parseInt(sm[1]),unit:u};
  return null;
}

function tempToBracket(temp){
  // temp in market units, match against current B array
  const rd=Math.round(temp);
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.type==="below"&&rd<=p.high)return label;
    if(p.type==="above"&&rd>=p.low)return label;
    if(p.type==="single"&&rd===p.val)return label;
    if(p.type==="range"&&rd>=p.low&&rd<=p.high)return label;
  }
  return B[0]||null; // fallback to lowest
}

function bracketShortLabel(label){
  return label.replace(/Â°[CF]\s*or below/,"â‰¤").replace(/Â°[CF]\s*or higher/,"+").replace(/Â°[CF]/,"");
}

function bracketRange(){
  // Get min/max degree values from brackets for Monte Carlo range
  let mn=999,mx=-999;
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.val!==undefined){mn=Math.min(mn,p.val);mx=Math.max(mx,p.val)}
    if(p.low!==undefined)mn=Math.min(mn,p.low);
    if(p.high!==undefined)mx=Math.max(mx,p.high);
  }
  return{min:mn-5,max:mx+5}; // padding for Monte Carlo tails
}

function isImpossibleAfterObservedHigh(label,observedHigh){
  if(observedHigh==null)return false;
  const p=parseBracket(label);if(!p)return false;
  const obs=parseFloat(observedHigh);
  if(Number.isNaN(obs))return false;
  if(p.type==="below")return obs>p.high;
  if(p.type==="single")return obs>p.val;
  if(p.type==="range")return obs>p.high;
  return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CITY SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectCity(key){
  CITY=CITIES[key];
  // Reset all state
  B=[];TOKENS={};prices={};books={};rawProbs={};corrProbs={};
  ensMean=0;ensCount=0;metarTemp=null;metarHigh=null;metarDayMax=null;
  _marketsDiscovered=false;
  // Immediately clear analysis display to prevent stale brackets showing
  $("tbl").innerHTML="";$("totals").innerHTML="";$("hist").innerHTML="";
  $("sigT").textContent="Loading...";$("sigN").textContent="â€”";$("sigD").innerHTML="";
  $("sigB").style.borderColor="var(--bd)";
  $("dHs").textContent="loading...";
  $("ensSrc").textContent="loading...";
  // Update UI
  renderCityNav();
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span></span>";
  $("stationInfo").textContent=CITY.icao+" "+CITY.lat.toFixed(3)+"Â°N "+Math.abs(CITY.lon).toFixed(3)+"Â°"+(CITY.lon>=0?"E":"W");
  $("curTs").textContent="station "+CITY.icao;
  $("curT").textContent="â€”";$("dH").textContent="â€”";$("ensMean").textContent="â€”";
  // Update bias banner
  if(CITY.bias.sd>0){
    const modelList=CITY.ensembleModels.split(",").map(m=>m.replace("_ensemble","").replace("_eps","").replace("_seamless","").replace("_global","").replace("025","")).join(" + ");
    $("biasWarn").innerHTML=`<b>Bias</b>: +${CITY.bias.mean}${unitLabel()} Ïƒ=${CITY.bias.sd} (${CITY.bias.note}) Â· Models: ${modelList}${CITY.syntheticModel?" + KMA":""}`;
    $("biasWarn").style.display="";
  }else{
    $("biasWarn").innerHTML=`<b>No bias correction</b> â€” ${CITY.name} uncalibrated. Using raw ensemble probabilities.`;
    $("biasWarn").style.display="";
  }
  // Update footer
  $("footer").innerHTML=`Not financial advice Â· Ensemble: Open-Meteo Â· Bias: +${CITY.bias.mean}${unitLabel()} Ïƒ=${CITY.bias.sd} (METAR-calibrated) Â· Resolution: <a href="${CITY.wunderground}" target="_blank">Wunderground ${CITY.icao}</a>`;
  // Re-initialize dates for this city
  ACTIVE_DATE=buildDateConfig(new Date().toISOString().split("T")[0]);
  ALL_DATES=generateDates().map(buildDateConfig);
  fillConfigInputs(RUNTIME_EFFECTIVE);
  updateActivePositionNotice();
  renderDateTabs();
  log("Switched to "+CITY.name+" ("+CITY.icao+")","lo");
  refresh();
}

function renderCityNav(){
  $("cityNav").innerHTML=Object.entries(CITIES).map(([key,c])=>{
    const active=c.icao===CITY.icao?"active":"";
    return`<div class="sb-item ${active}" onclick="selectCity('${key}')">
      <span class="sb-flag">${c.flag}</span>
      <div><div>${c.name}</div><div class="sb-meta">${c.icao} Â· Â°${c.unit}</div></div>
    </div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADING MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilters(a){
  const f=F(),reasons=[];
  if(!a.isCandidate)reasons.push("Outside favorite Â±1");
  if(a.trueEdge<f.minEdge)reasons.push(`Edge ${(a.trueEdge*100).toFixed(1)}pt < ${(f.minEdge*100)}pt min`);
  if(a.askD<f.minDepth&&f.minDepth>0)reasons.push(`Depth ${a.askD.toFixed(0)} < ${f.minDepth} min`);
  if(a.ask>f.maxAsk&&f.maxAsk<1)reasons.push(`Ask ${(a.ask*100).toFixed(0)}Â¢ > ${(f.maxAsk*100)}Â¢ max`);
  if(f.minModels>0&&a.modelVotes!==undefined&&a.modelVotes<f.minModels)reasons.push(`Only ${a.modelVotes}/${CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)} models agree (need ${f.minModels})`);
  if(a.lateImpossible)reasons.push(`Observed high ${a.observedHighText} already above bracket`);
  if(a.latePhase==="freeze"&&LATE_GUARD_CONFIG.freezeAllNewEntries)reasons.push("Late freeze window");
  if(a.latePhase==="after_cutoff"&&LATE_GUARD_CONFIG.favoriteOnlyAfterCutoff&&!a.isFavorite)reasons.push("Late cutoff: non-favorite blocked");
  if((a.latePhase==="after_cutoff"||a.latePhase==="freeze")&&a.trueEdge<LATE_GUARD_CONFIG.minEdgeAfterCutoff){
    reasons.push(`Late edge ${(a.trueEdge*100).toFixed(1)}pt < ${(LATE_GUARD_CONFIG.minEdgeAfterCutoff*100).toFixed(0)}pt`);
  }
  return{pass:reasons.length===0&&a.trueEdge>0,reasons};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MONTHS=["january","february","march","april","may","june","july","august","september","october","november","december"];
const MONTHS_SHORT=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

function buildDateConfig(dateStr){
  const d=new Date(dateStr+"T12:00:00Z");
  const y=d.getUTCFullYear(),m=d.getUTCMonth(),day=d.getUTCDate();
  const monthName=MONTHS[m],monthShort=MONTHS_SHORT[m];
  const dayPad=String(day).padStart(2,"0");
  const today=new Date();today.setUTCHours(12,0,0,0);
  const todayStr=today.toISOString().split("T")[0];
  const isToday=dateStr===todayStr,isPast=dateStr<todayStr,isFuture=dateStr>todayStr;
  const slug=`highest-temperature-in-${CITY.polyCity}-on-${monthName}-${day}-${y}`;
  return{
    dateStr,dayOfMonth:day,dayPad,
    display:`${monthShort} ${day} ${y}`,displayShort:`${monthShort} ${day}`,
    slug,polyUrl:`https://gamma-api.polymarket.com/events?slug=${slug}`,
    ensDatePrefix:`${y}-${String(m+1).padStart(2,"0")}-${dayPad}`,
    metarDayPattern:new RegExp(`${CITY.icao}\\s+${dayPad}\\d{4}Z`),
    // Timezone-aware local date filter for METAR obsTime (epoch secs)
    // Wunderground convention: 00:00 belongs to previous day (end of day, not start)
    metarLocalDateFilter: function(obsTimeSec){
      if(!obsTimeSec) return false;
      try{
        const d=new Date(obsTimeSec*1000);
        const localDate=d.toLocaleDateString('en-CA',{timeZone:CITY.tz}); // YYYY-MM-DD
        if(localDate!==dateStr) return false;
        // Exclude exact midnight (00:00:00) â€” Wunderground assigns it to previous day
        const localTime=d.toLocaleTimeString('en-GB',{timeZone:CITY.tz,hour12:false});
        return localTime!=="00:00:00";
      }catch(e){return false}
    },
    startUTC:`${dateStr}T00:00:00Z`,
    endUTC:(()=>{const n=new Date(d);n.setUTCDate(n.getUTCDate()+1);return n.toISOString().split("T")[0]+"T00:00:00Z"})(),
    isToday,isPast,isFuture,
  };
}

function generateDates(){
  const dates=[],today=new Date();today.setUTCHours(12,0,0,0);
  for(let offset=-3;offset<=1;offset++){const d=new Date(today);d.setUTCDate(d.getUTCDate()+offset);dates.push(d.toISOString().split("T")[0])}
  return dates;
}

let ACTIVE_DATE=buildDateConfig(new Date().toISOString().split("T")[0]);
let ALL_DATES=generateDates().map(buildDateConfig);
let LIVE_MARKETS={};

async function discoverMarkets(){
  const candidates=generateDates().map(buildDateConfig);
  const probes=candidates.map(async dc=>{
    for(const fetcher of [u=>u,...PX]){
      try{
        const url=typeof fetcher==='function'?fetcher(dc.polyUrl):dc.polyUrl;
        const r=await fetch(url,{signal:AbortSignal.timeout(8000)});
        if(!r.ok)continue;
        const d=JSON.parse(await r.text());
        const ev=Array.isArray(d)?d[0]:d;
        if(ev&&ev.markets&&ev.markets.length>0){
          LIVE_MARKETS[dc.dateStr]={exists:true,active:ev.active,closed:ev.closed};
          return{...dc,marketExists:true,active:ev.active,closed:ev.closed};
        }
      }catch(e){}
    }
    return{...dc,marketExists:false};
  });
  const settled=await Promise.all(probes);
  ALL_DATES=settled.filter(dc=>dc.marketExists);
  if(!ALL_DATES.length){ALL_DATES=[buildDateConfig(new Date().toISOString().split("T")[0])];log("No markets found â€” fallback to today","lw")}
  if(!ALL_DATES.find(dc=>dc.dateStr===ACTIVE_DATE.dateStr)){
    const today=new Date().toISOString().split("T")[0];
    const fb=ALL_DATES.find(dc=>dc.dateStr===today)||ALL_DATES[0];
    if(fb)ACTIVE_DATE=buildDateConfig(fb.dateStr);
  }
  renderDateTabs();
  log("Found "+ALL_DATES.length+" "+CITY.name+" markets","lo");
}

function selectDate(dateStr){
  ACTIVE_DATE=buildDateConfig(dateStr);
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span>Â· "+ACTIVE_DATE.display+"</span>";
  document.querySelector("title").textContent="Weather Trader â€” "+CITY.name+" "+ACTIVE_DATE.displayShort;
  $("dH").textContent="â€”";$("dHs").textContent=ACTIVE_DATE.isToday?"Awaiting data":(ACTIVE_DATE.isPast?"Loading...":"Forecast only");
  metarHigh=null;metarTemp=null;metarDayMax=null;
  B=[];prices={};books={};TOKENS={};rawProbs={};corrProbs={};ensMean=0;ensCount=0;
  document.querySelectorAll(".dtab").forEach(t=>t.classList.toggle("active",t.dataset.date===dateStr));
  updateActivePositionNotice();
  refresh();
}

function renderDateTabs(){
  const c=$("dateTabs");
  if(!ALL_DATES.length){c.innerHTML=`<div style="color:var(--dm);font-size:10px">Discovering markets...</div>`;return}
  c.innerHTML=ALL_DATES.map(dc=>{
    const active=dc.dateStr===ACTIVE_DATE.dateStr?"active":"";
    const mkt=LIVE_MARKETS[dc.dateStr]||{};
    let tag,tagClass;
    if(mkt.closed){tag="CLOSED";tagClass="dtag-past"}
    else if(dc.isToday){tag="TODAY";tagClass="dtag-today"}
    else if(dc.isFuture){tag="UPCOMING";tagClass="dtag-future"}
    else{tag="PAST";tagClass="dtag-past"}
    return`<div class="dtab ${active}" data-date="${dc.dateStr}" onclick="selectDate('${dc.dateStr}')">${dc.displayShort}<span class="dtag ${tagClass}">${tag}</span></div>`;
  }).join("");
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIAS CORRECTION (generalized)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t^=t+Math.imul(t^t>>>7,61|t);return((t^t>>>14)>>>0)/4294967296}}

function biasCorrect(rawDistByDeg){
  // rawDistByDeg: {degreeInMarketUnits: probability}
  // Returns corrected distribution in same units
  if(CITY.bias.sd===0)return{...rawDistByDeg}; // no correction, pass through
  const N=50000,rng=mulberry32(42);
  const range=bracketRange();
  const counts={};
  for(let i=range.min;i<=range.max;i++)counts[i]=0;
  // Find median degree for fallback
  const allDegs=Object.keys(rawDistByDeg).map(Number);
  const medDeg=allDegs.length?allDegs[Math.floor(allDegs.length/2)]:0;
  for(let i=0;i<N;i++){
    let r=rng(),cum=0,baseDeg=medDeg;
    for(const[deg,prob] of Object.entries(rawDistByDeg)){
      cum+=prob;if(r<=cum){baseDeg=parseInt(deg);break}
    }
    const baseT=baseDeg+(rng()-0.5);
    const u1=rng(),u2=rng();
    const z=Math.sqrt(-2*Math.log(u1+1e-10))*Math.cos(2*Math.PI*u2);
    const metarT=baseT+CITY.bias.mean+CITY.bias.sd*z;
    const rounded=Math.round(metarT);
    if(rounded>=range.min&&rounded<=range.max)counts[rounded]++;
  }
  const total=Object.values(counts).reduce((s,v)=>s+v,0);
  const result={};
  for(let i=range.min;i<=range.max;i++){if(counts[i]>0)result[i]=counts[i]/total}
  return result;
}

function mapToLabels(distByDeg){
  // Map degree-keyed distribution to bracket-label-keyed distribution
  const r={};
  for(const label of B){
    const p=parseBracket(label);if(!p)continue;
    if(p.type==="below")r[label]=Object.entries(distByDeg).filter(([k])=>parseInt(k)<=p.high).reduce((s,[,v])=>s+v,0);
    else if(p.type==="above")r[label]=Object.entries(distByDeg).filter(([k])=>parseInt(k)>=p.low).reduce((s,[,v])=>s+v,0);
    else if(p.type==="single")r[label]=distByDeg[p.val]||0;
    else if(p.type==="range")r[label]=Object.entries(distByDeg).filter(([k])=>{const d=parseInt(k);return d>=p.low&&d<=p.high}).reduce((s,[,v])=>s+v,0);
  }
  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH FUNCTIONS (all parameterized by CITY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchEnsemble(){
  try{
    const url=`https://ensemble-api.open-meteo.com/v1/ensemble?latitude=${CITY.lat}&longitude=${CITY.lon}&hourly=temperature_2m&models=${CITY.ensembleModels}&forecast_days=7&timezone=${CITY.tz}`;
    const r=await fetch(url,{signal:AbortSignal.timeout(15000)});
    if(!r.ok)throw new Error("HTTP "+r.status);
    const d=await r.json(),hourly=d.hourly||{},times=hourly.time||[];
    const memberKeys=Object.keys(hourly).filter(k=>k.startsWith("temperature_2m_member"));
    if(!memberKeys.length)throw new Error("No ensemble members");
    const targetIdx=[];
    for(let i=0;i<times.length;i++){if(times[i]&&times[i].startsWith(ACTIVE_DATE.ensDatePrefix))targetIdx.push(i)}
    if(!targetIdx.length)throw new Error("No "+ACTIVE_DATE.displayShort+" data");
    const maxTemps=[],modelVotesPerDeg={};
    for(const mk of memberKeys){
      const vals=hourly[mk];let mx=-999;
      for(const i of targetIdx){if(vals[i]!=null&&vals[i]>mx)mx=vals[i]}
      if(mx>-999){
        const mktTemp=ensToMarket(mx); // convert to market units
        maxTemps.push(mktTemp);
        let model="x";
        if(mk.includes("ecmwf_ifs"))model="ifs";else if(mk.includes("ecmwf_aifs"))model="aifs";
        else if(mk.includes("icon"))model="ico";else if(mk.includes("gem"))model="gem";
        else if(mk.includes("ukmo"))model="ukmo";else if(mk.includes("bom"))model="bom";
        else if(mk.includes("gfs")||mk.includes("ncep"))model="gfs";
        const rd=Math.round(mktTemp);
        if(!modelVotesPerDeg[rd])modelVotesPerDeg[rd]={};
        modelVotesPerDeg[rd][model]=true;
      }
    }
    // If city has a synthetic model (e.g. KMA for Seoul), fetch deterministic forecast & add synthetic members
    if(CITY.syntheticModel){
      try{
        const sUrl=`https://api.open-meteo.com/v1/forecast?latitude=${CITY.lat}&longitude=${CITY.lon}&daily=temperature_2m_max&models=${CITY.syntheticModel}&forecast_days=7&timezone=${CITY.tz}`;
        const sR=await fetch(sUrl,{signal:AbortSignal.timeout(10000)});
        if(sR.ok){
          const sD=await sR.json(),sDates=sD.daily?.time||[],sMaxes=sD.daily?.temperature_2m_max||[];
          const sIdx=sDates.indexOf(ACTIVE_DATE.dateStr);
          if(sIdx>=0&&sMaxes[sIdx]!=null){
            const synT=ensToMarket(sMaxes[sIdx]); // Â°C â†’ market units
            // Add 10 synthetic members with tiny noise around the forecast
            for(let i=0;i<10;i++){
              const jitter=(Math.random()-0.5)*0.6; // Â±0.3Â° noise
              const t=synT+jitter;
              maxTemps.push(t);
              const rd=Math.round(t);
              if(!modelVotesPerDeg[rd])modelVotesPerDeg[rd]={};
              modelVotesPerDeg[rd]["kma"]=true;
            }
            log("KMA synthetic: "+synT.toFixed(1)+unitLabel()+" (10 members)","lo");
          }
        }
      }catch(e){log("KMA synthetic: "+e.message,"le")}
    }
    window._modelAgreement={};
    for(const[deg,models] of Object.entries(modelVotesPerDeg))window._modelAgreement[parseInt(deg)]=Object.keys(models).length;
    // Build raw distribution in market units
    const range=bracketRange();
    const rawCounts={};
    for(let i=range.min;i<=range.max;i++)rawCounts[i]=0;
    for(const t of maxTemps){const rd=Math.round(t);if(rd>=range.min&&rd<=range.max)rawCounts[rd]++}
    const total=maxTemps.length;
    const rawByDeg={};
    for(let i=range.min;i<=range.max;i++){if(rawCounts[i]>0)rawByDeg[i]=rawCounts[i]/total}
    rawProbs=mapToLabels(rawByDeg);
    ensMean=maxTemps.reduce((s,v)=>s+v,0)/total;ensCount=total;
    const corrByDeg=biasCorrect(rawByDeg);
    corrProbs=mapToLabels(corrByDeg);
    $("ensMean").textContent=ensMean.toFixed(1)+unitLabel();
    $("ensSrc").textContent=ensCount+" members Â· live";
    log("Ensemble: "+ensCount+" members, mean "+ensMean.toFixed(1)+unitLabel(),"lo");
  }catch(e){
    log("Ensemble: "+e.message,"le");
    rawProbs={};corrProbs={};ensMean=0;ensCount=0;
    $("ensMean").textContent="â€”";$("ensSrc").textContent="error";
  }
}

async function fetchMetar(){
  const metarUrl=`https://aviationweather.gov/api/data/metar?ids=${CITY.icao}&format=json&hours=72`;
  try{
    const r=await fetch(PX[0](metarUrl),{signal:AbortSignal.timeout(10000)});
    if(!r.ok)throw new Error("HTTP "+r.status);
    const d=JSON.parse(await r.text());
    if(d.length){
      metarTemp=d[0].temp;
      const displayTemp=CITY.unit==="F"?cToF(metarTemp).toFixed(0)+"Â°F":metarTemp+"Â°C";
      $("curT").textContent=displayTemp;
      $("curTs").textContent="METAR "+d[0].rawOb.substring(5,16);
      // Filter by LOCAL date using obsTime (timezone-aware)
      const dayObs=d.filter(m=>ACTIVE_DATE.metarLocalDateFilter(m.obsTime));
      if(dayObs.length){
        const mxC=Math.max(...dayObs.map(m=>m.temp));
        metarHigh=mxC;metarDayMax=CITY.unit==="F"?Math.round(cToF(mxC)):mxC;
        $("dH").textContent=(CITY.unit==="F"?Math.round(cToF(mxC))+"Â°F":mxC+"Â°C");
        $("dHs").textContent="METAR max "+ACTIVE_DATE.displayShort;
      }
      log("METAR: "+displayTemp,"lo");
    }
  }catch(e){
    try{
      const r2=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${CITY.lat}&longitude=${CITY.lon}&current=temperature_2m&timezone=${CITY.tz}`,{signal:AbortSignal.timeout(8000)});
      const d2=await r2.json();
      if(d2.current){metarTemp=d2.current.temperature_2m;const dt=CITY.unit==="F"?cToF(metarTemp).toFixed(0)+"Â°F":metarTemp+"Â°C";$("curT").textContent=dt;$("curTs").textContent="Open-Meteo (not METAR)"}
      log("METAR failed, using Open-Meteo","lw");
    }catch(e2){log("Weather: "+e2.message,"le")}
  }
}

async function fetchPoly(){
  const order=[pxi,...[0,1,2].filter(i=>i!==pxi)];
  const cacheBust=Date.now(); // prevent proxy caching across cities
  for(const idx of order){
    try{
      const baseUrl=PX[idx](ACTIVE_DATE.polyUrl);
      const sep=baseUrl.includes("?")?"%26":"?";
      const url=baseUrl+(idx>0?sep+"_t="+cacheBust:""); // add cache-buster for proxies
      const r=await fetch(url,{signal:AbortSignal.timeout(10000)});
      if(!r.ok)throw new Error("HTTP "+r.status);
      const d=JSON.parse(await r.text()),ev=Array.isArray(d)?d[0]:d;
      if(!ev||!ev.markets)throw new Error("No markets");
      const p={},tk={},bracketLabels=[];
      for(const m of ev.markets){
        const nm=m.groupItemTitle||"";if(!nm)continue;
        let op;try{op=JSON.parse(m.outcomePrices||"[]")}catch(e){continue}
        if(op[0])p[nm]=parseFloat(op[0]);
        try{const tids=JSON.parse(m.clobTokenIds||"[]");if(tids[0])tk[nm]=tids[0]}catch(e){}
        bracketLabels.push(nm);
      }
      if(!Object.keys(p).length)throw new Error("Empty");
      // Validate: check slug in response matches expected city
      const evSlug=ev.slug||"";
      if(evSlug&&!evSlug.includes(CITY.polyCity)){
        log("Poly: slug mismatch! Got "+evSlug+", expected "+CITY.polyCity,"le");
        throw new Error("Slug mismatch");
      }
      prices=p;
      // Sort brackets by their temperature value
      bracketLabels.sort((a,b)=>{
        const pa=parseBracket(a),pb=parseBracket(b);
        const va=pa?(pa.val??pa.low??pa.high??0):0;
        const vb=pb?(pb.val??pb.low??pb.high??0):0;
        return va-vb;
      });
      B=bracketLabels;
      if(Object.keys(tk).length){TOKENS=tk;log("Token IDs: "+Object.keys(tk).length+" brackets","lo")}
      pxi=idx;log("Prices: "+B.length+" brackets via proxy "+idx+" ("+CITY.name+")","lo");return;
    }catch(e){log("Proxy "+idx+": "+e.message,"le")}
  }
  // All proxies failed - ensure brackets are cleared
  B=[];prices={};TOKENS={};
  log("Poly: all proxies failed for "+CITY.name+" "+ACTIVE_DATE.displayShort,"le");
}

async function fetchBooks(){
  if(!Object.keys(TOKENS).length){log("No token IDs â€” skipping books","lw");return}
  let ok=0;
  for(const[name,tid] of Object.entries(TOKENS)){
    try{
      const url=`https://clob.polymarket.com/book?token_id=${tid}`;
      const r=await fetch(url,{signal:AbortSignal.timeout(8000)});if(!r.ok)continue;
      const d=await r.json();
      const bids=(d.bids||[]).sort((a,b)=>parseFloat(b.price)-parseFloat(a.price));
      const asks=(d.asks||[]).sort((a,b)=>parseFloat(a.price)-parseFloat(b.price));
      const bb=bids.length?parseFloat(bids[0].price):0;
      const ba=asks.length?parseFloat(asks[0].price):1;
      books[name]={bids,asks,bb,ba,mid:(bb+ba)/2,spd:ba-bb,spdPct:(bb+ba)>0?(ba-bb)/((bb+ba)/2)*100:0,
        bidD:bids.reduce((s,x)=>s+parseFloat(x.size),0),askD:asks.reduce((s,x)=>s+parseFloat(x.size),0),
        last:parseFloat(d.last_trade_price||0)};
      ok++;
    }catch(e){}
  }
  if(ok)log("Books: "+ok+"/"+Object.keys(TOKENS).length,"lo");
}

async function fetchGas(){
  try{
    const[gR,pR]=await Promise.all([
      fetch("https://gasstation.polygon.technology/v2",{signal:AbortSignal.timeout(5000)}),
      fetch("https://api.coingecko.com/api/v3/simple/price?ids=polygon-ecosystem-token&vs_currencies=usd",{signal:AbortSignal.timeout(5000)})
    ]);
    const g=await gR.json(),pp=await pR.json();
    const totalGwei=g.estimatedBaseFee+g.standard.maxPriorityFee;
    polPrice=pp['polygon-ecosystem-token']?.usd||0.35;
    gasCostUsd=200000*totalGwei/1e9*polPrice;
    log("Gas: $"+gasCostUsd.toFixed(4)+"/trade","lo");
  }catch(e){gasCostUsd=0.03;log("Gas: fallback $0.03","lw")}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  if(!B.length||!Object.keys(prices).length)return;
  if(!Object.keys(corrProbs).length&&!Object.keys(rawProbs).length)return;
  const useRaw=!Object.keys(corrProbs).length; // if no corrected, use raw
  const ma=window._modelAgreement||{};
  const favoriteLabel=B.reduce((best,label)=>{
    const bk=books[label],ask=bk?bk.ba:(prices[label]||0);
    if(ask>best.ask)return{label,ask};
    return best;
  },{label:null,ask:-1}).label;
  const favoriteIdx=B.indexOf(favoriteLabel);
  const candidateSet=new Set([favoriteIdx-1,favoriteIdx,favoriteIdx+1].filter(i=>i>=0&&i<B.length).map(i=>B[i]));
  const nowLocalHour=localHourInTZ(CITY.tz);
  const localDateNow=localDateInTZ(CITY.tz);
  const cutoffHour=LATE_GUARD_CONFIG.cutoffByCity[CITY.polyCity]??LATE_GUARD_CONFIG.defaultCutoffHour;
  const freezeHour=Math.min(23,cutoffHour+LATE_GUARD_CONFIG.freezeHoursAfterCutoff);
  const lateApplies=LATE_GUARD_CONFIG.enabled&&localDateNow===ACTIVE_DATE.dateStr;
  const latePhase=lateApplies?(nowLocalHour>=freezeHour?"freeze":nowLocalHour>=cutoffHour?"after_cutoff":"normal"):"inactive";
  const activeNow=activeBracketSetForCurrentMarket();
  const A=B.map(b=>{
    const rawP=rawProbs[b]||0,corP=(useRaw?rawP:corrProbs[b])||0,bk=books[b],mkt=prices[b]||0;
    const ask=bk?bk.ba:mkt,bid=bk?bk.bb:0,mid=bk?bk.mid:mkt;
    const rawEdge=corP-mid;
    const baseTrueEdge=corP-ask;
    const pb=parseBracket(b);
    const deg=pb?(pb.val??pb.low??pb.high??0):0;
    const modelVotes=ma[deg]||0;
    const isFavorite=b===favoriteLabel;
    const isCandidate=candidateSet.has(b);
    const lateImpossible=lateApplies?isImpossibleAfterObservedHigh(b,metarDayMax):false;
    // Check neighboring degrees for range brackets
    let mv=modelVotes;
    if(pb&&pb.type==="range"){for(let d=pb.low;d<=pb.high;d++)mv=Math.max(mv,ma[d]||0)}
    let bet=0,ev=0,sig="PASS",fFull=0,contracts=0;
    let fillFraction=1,immediateFillFraction=1,continuationFillProb=1;
    let feePerContract=0,gasPerContract=0,slippagePenalty=0;
    let effectiveAsk=ask,edgeAfterCosts=baseTrueEdge,trueEdge=baseTrueEdge;
    if(ask>0&&ask<1&&corP>0){
      // Pass 1: rough size for execution estimate
      const bo0=(1-ask)/ask,q0=1-corP;
      const f0=Math.max(0,(bo0*corP-q0)/bo0);
      const bet0=Math.round(f0*KELLY_FRAC*BR*100)/100;
      const hint=Math.max(1,Math.floor(bet0/ask)||1);

      let est=estimateExecution(bk,ask,hint);
      fillFraction=est.fillFraction;
      immediateFillFraction=est.immediateFillFraction;
      continuationFillProb=est.continuationFillProb;
      slippagePenalty=EXEC_CONFIG.enabled?est.slippagePenalty:0;

      feePerContract=EXEC_CONFIG.enabled?ask*EXEC_CONFIG.feeRate:0;
      const gasPerOrder=EXEC_CONFIG.useLiveGasEstimate?gasCostUsd:EXEC_CONFIG.gasUsdPerOrder;
      gasPerContract=EXEC_CONFIG.enabled?gasPerOrder/hint:0;
      effectiveAsk=Math.min(0.99,ask+feePerContract+gasPerContract+slippagePenalty);

      const kPrice=EXEC_CONFIG.enabled?effectiveAsk:ask;
      if(kPrice>0&&kPrice<1){
        const bo=(1-kPrice)/kPrice,q=1-corP;
        fFull=(bo*corP-q)/bo;
        const fillMult=EXEC_CONFIG.enabled?fillFraction:1;
        const fK=Math.max(0,fFull*KELLY_FRAC*fillMult);
        bet=Math.round(fK*BR*100)/100;
        contracts=bet>0?Math.floor(bet/ask):0;
      }

      // Pass 2: recompute costs with final size
      if(contracts>0){
        est=estimateExecution(bk,ask,contracts);
        fillFraction=est.fillFraction;
        immediateFillFraction=est.immediateFillFraction;
        continuationFillProb=est.continuationFillProb;
        slippagePenalty=EXEC_CONFIG.enabled?est.slippagePenalty:0;
        feePerContract=EXEC_CONFIG.enabled?ask*EXEC_CONFIG.feeRate:0;
        gasPerContract=EXEC_CONFIG.enabled?gasPerOrder/contracts:0;
        effectiveAsk=Math.min(0.99,ask+feePerContract+gasPerContract+slippagePenalty);
      }

      edgeAfterCosts=corP-effectiveAsk;
      trueEdge=EXEC_CONFIG.enabled?edgeAfterCosts*fillFraction:edgeAfterCosts;
      ev=contracts>0?Math.round(contracts*fillFraction*edgeAfterCosts*100)/100:0;
    }
    if(trueEdge>.03)sig="BUY";else if(trueEdge>0)sig="LEAN";
    const row={bracket:b,rawP,corP,mktP:prices[b]||0,bid,ask,mid,spread:bk?bk.spd:0,
      rawEdge,baseTrueEdge,trueEdge,edgeAfterCosts,effectiveAsk,fillFraction,immediateFillFraction,
      continuationFillProb,feePerContract,gasPerContract,slippagePenalty,executionAdjusted:EXEC_CONFIG.enabled,
      bet,ev,sig,fFull,contracts,bidD:bk?bk.bidD:0,askD:bk?bk.askD:0,last:bk?bk.last:0,modelVotes:mv,
      isFavorite,isCandidate,isActive:activeNow.has(b),latePhase,lateImpossible,observedHighText:metarDayMax==null?"â€”":String(metarDayMax)};
    if(row.isActive){
      row.sig="ACTIVE";
      row.filterReasons=["Already holding this bracket"];
      row.bet=0;
      row.ev=0;
    }else if(LIVE_MODE&&(sig==="BUY"||sig==="LEAN")){
      const filt=applyFilters(row);
      if(!filt.pass){row.sig="FILTERED";row.filterReasons=filt.reasons;row.bet=0;row.ev=0}
    }
    return row;
  });

  // Signal banner
  const actionable=A.filter(a=>a.sig==="BUY").sort((a,b)=>b.trueEdge-a.trueEdge);
  const filtered=A.filter(a=>a.sig==="FILTERED");
  const activeRows=A.filter(a=>a.sig==="ACTIVE");
  const best=actionable[0];
  const bn=$("sigB");
  if(best){
    bn.style.borderColor="rgba(22,163,74,.2)";$("sigT").style.color="var(--gn)";
    $("sigT").textContent="BUY (strict filters passed)";
    $("sigN").textContent=best.bracket;
    $("sigD").innerHTML=[
      ["Corrected",(best.corP*100).toFixed(1)+"%","var(--gn)"],
      ["Ask",(best.ask*100).toFixed(1)+"Â¢","var(--tx)"],
      ["Eff Ask",(best.effectiveAsk*100).toFixed(1)+"Â¢","var(--tx)"],
      ["Fill",(best.fillFraction*100).toFixed(0)+"%","var(--tx)"],
      ["True Edge","+"+(best.trueEdge*100).toFixed(1)+"pt","var(--gn)"],
      ["Models",best.modelVotes+"/"+(CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)),"var(--gn)"],
      ["â…“Kelly","$"+best.bet.toFixed(2),"var(--gn)"],
      ["E[Profit]","+$"+best.ev.toFixed(2),"var(--gn)"],
    ].map(([l,v,c])=>`<div class="si"><div class="si-l">${l}</div><div class="si-v" style="color:${c}">${v}</div></div>`).join("");
  }else if(activeRows.length>0){
    bn.style.borderColor="rgba(74,134,200,.25)";$("sigT").style.color="var(--h1)";
    $("sigT").textContent="Position already active";
    $("sigN").textContent=activeRows.map(a=>a.bracket).join(", ");
    $("sigD").innerHTML=activeRows.map(a=>`<div style="font-size:10px;color:var(--h1);margin:2px 0">${a.bracket}: already in portfolio for ${CITY.name} ${ACTIVE_DATE.displayShort}</div>`).join("");
  }else if(filtered.length>0){
    bn.style.borderColor="var(--bd)";$("sigT").style.color="var(--dm)";
    $("sigT").textContent=filtered.length+" signal(s) filtered by live-mode rules";
    $("sigN").textContent="NO TRADE";
    $("sigD").innerHTML=filtered.map(f=>`<div style="font-size:10px;color:var(--dm);margin:2px 0">${f.bracket}: ${(f.filterReasons||[]).join(" Â· ")}</div>`).join("");
  }else{
    bn.style.borderColor="var(--bd)";$("sigT").style.color="var(--dm)";
    $("sigT").textContent="No actionable signal";$("sigN").textContent="â€”";$("sigD").innerHTML="";
  }

  // Main table
  const maxMktP=A.reduce((m,a)=>Math.max(m,a.mktP||0),0);
  let h="",tB=0,tE=0;
  for(const a of A){
    const hl=a.sig==="BUY"||a.sig==="LEAN"||a.sig==="ACTIVE";
    const isF=a.sig==="FILTERED";
    const tec=a.trueEdge>.03?"var(--gn)":a.trueEdge>0?"rgba(22,163,74,.5)":a.trueEdge<-.03?"var(--rd)":"var(--dm)";
    let tg;
    if(a.sig==="BUY")tg='<span class="tb tb-b">BUY</span>';
    else if(a.sig==="LEAN")tg='<span class="tb tb-l">LEAN</span>';
    else if(a.sig==="ACTIVE")tg='<span class="tb" style="background:rgba(74,134,200,.09);color:var(--h1)">ACTIVE</span>';
    else if(isF){
      const reason=(a.filterReasons||[]).join(" Â· ");
      tg=`<span class="tb tb-blocked" title="${escAttr(reason)}">BLOCKED</span>`;
    }
    else tg='<span style="color:var(--dm);font-size:9px">â€”</span>';
    if(a.bet>0){tB+=a.bet;tE+=a.ev}
    const totalModels=CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0);
    const mvPct=totalModels>0?a.modelVotes/totalModels:0;
    const mvC=mvPct>=0.75?"var(--gn)":mvPct>=0.5?"var(--am)":"var(--rd)";
    const ft=isF&&a.filterReasons?` title="${escAttr(a.filterReasons.join("; "))}"`:"";
    const isMktFav=maxMktP>0&&Math.abs((a.mktP||0)-maxMktP)<1e-9;
    h+=`<tr class="${hl?"rh":""} ${a.isActive?"pos-w":""}"${ft}><td>${a.bracket}</td>
    <td style="text-align:center">${tg}</td>
    <td style="color:var(--dm)">${(a.rawP*100).toFixed(1)}%</td>
    <td style="color:var(--tx);font-weight:500">${(a.corP*100).toFixed(1)}%</td>
    <td style="color:var(--dm)">${isMktFav?`<span class="mfav" title="Market favorite">${(a.mktP*100).toFixed(0)}%</span>`:`${(a.mktP*100).toFixed(0)}%`}</td>
    <td style="color:var(--dm)">${a.bid.toFixed(3)}</td><td title="effective ${a.effectiveAsk.toFixed(3)}">${a.ask.toFixed(3)}</td>
    <td style="color:var(--dm)">${a.spread>0?(a.spread*100).toFixed(1)+"Â¢":"â€”"}</td>
    <td style="color:${a.rawEdge>0?"rgba(22,163,74,.5)":"var(--dm)"}">${a.rawEdge>=0?"+":""}${(a.rawEdge*100).toFixed(1)}</td>
    <td style="color:${tec};font-weight:700">${a.trueEdge>=0?"+":""}${(a.trueEdge*100).toFixed(1)}</td>
    <td style="color:${mvC};font-size:10px">${a.modelVotes}/${CITY.ensembleModels.split(",").length+(CITY.syntheticModel?1:0)}</td>
    <td style="color:${a.bet>0?"var(--gn)":a.isActive?"var(--h1)":"var(--dm)"}">${a.bet>0?"$"+a.bet.toFixed(2):a.isActive?"HOLD":"â€”"}</td>
    <td style="color:${a.ev>0?"var(--gn)":"var(--dm)"}">${a.ev>0?"+$"+a.ev.toFixed(2):"â€”"}</td></tr>`;
  }
  $("tbl").innerHTML=h;
  const feeLabel=(EXEC_CONFIG.feeRate*100).toFixed(2)+"%";
  $("totals").innerHTML=tB>0?
    `<span>Wagered: <b>$${tB.toFixed(2)}</b></span><span>E[Profit]: <b style="color:var(--gn)">+$${tE.toFixed(2)}</b></span><span>E[ROI]: <b style="color:var(--gn)">+${((tE/tB)*100).toFixed(0)}%</b></span><span style="color:var(--dm)">Gas est: $${gasCostUsd.toFixed(3)} | Fee: ${feeLabel}</span>`:
    (activeRows.length?`<span style="color:var(--h1)">Holding ${activeRows.length} active bracket(s) in this market; no duplicate buys.</span>`:'<span style="color:var(--dm)">No positions after analysis</span>');

  // Histogram
  const vis=B.filter(b=>(rawProbs[b]||0)>.001||(corrProbs[b]||0)>.001||(prices[b]||0)>.01);
  if(vis.length){$("histPanel").style.display="block";
    const mxP=0.40;
    $("hist").innerHTML=vis.map(b=>{
      const rp=rawProbs[b]||0,cp=(useRaw?rp:corrProbs[b])||0,mp=prices[b]||0;
      const rH=Math.max(rp>.005?2:0,rp/mxP*100),cH=Math.max(cp>.005?2:0,cp/mxP*100),mH=Math.max(mp>.005?2:0,mp/mxP*100);
      return`<div class="hc"><div class="hp">${(cp*100).toFixed(0)}%</div><div class="hbs"><div class="hb1" style="height:${rH}%;background:var(--h1);opacity:.45"></div><div class="hb2" style="height:${cH}%;background:var(--h2);opacity:.7"></div><div class="hb3" style="height:${mH}%;background:rgba(26,26,46,.15)"></div></div><div class="hl">${bracketShortLabel(b)}</div></div>`;
    }).join("");
  }else{$("histPanel").style.display="none"}

  $("ut").textContent=new Date().toLocaleTimeString();

  // Entry timing (live mode)
  const et=$("entryTiming");
  if(LIVE_MODE){
    et.style.display="block";
    let msg="",col="",bg="";
    if(!lateApplies){
      msg=`Late guard inactive for this date (local ${localDateNow}).`;
      col="var(--dm)";bg="rgba(39,39,42,.04)";
    }else if(latePhase==="normal"){
      msg=`Normal window (${CITY.tz}) â€” cutoff ${cutoffHour}:00 local.`;
      col="var(--gn)";bg="rgba(22,163,74,.04)";
    }else if(latePhase==="after_cutoff"){
      msg=`Late window (${CITY.tz}) â€” only favorite bracket allowed after ${cutoffHour}:00.`;
      col="var(--am)";bg="rgba(180,83,9,.06)";
    }else{
      msg=`Freeze window (${CITY.tz}) â€” no new entries after ${freezeHour}:00 local.`;
      col="var(--rd)";bg="rgba(220,38,38,.04)";
    }
    if(lateApplies&&metarDayMax!=null){
      msg+=` Observed high: ${metarDayMax}${unitLabel()}.`;
    }
    et.style.color=col;et.style.borderColor=col;et.style.background=bg;et.textContent=msg;
  }else{et.style.display="none"}
  $("stopLossWarn").style.display="none";
  updateActivePositionNotice();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _marketsDiscovered=false;
async function refresh(){
  $("badge").textContent="Refreshing...";
  if(!_marketsDiscovered){
    try{await Promise.race([discoverMarkets(),new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),10000))])}
    catch(e){
      log("Market discovery failed ("+e.message+"), using known dates","lw");
      const today=new Date();today.setUTCHours(12,0,0,0);
      const todayStr=today.toISOString().split("T")[0];
      const yd=new Date(today);yd.setUTCDate(yd.getUTCDate()-1);
      const tm=new Date(today);tm.setUTCDate(tm.getUTCDate()+1);
      ALL_DATES=[yd,today,tm].map(d=>buildDateConfig(d.toISOString().split("T")[0]));
      ACTIVE_DATE=buildDateConfig(todayStr);
    }
    _marketsDiscovered=true;renderDateTabs();
  }
  $("hdrTitle").innerHTML=CITY.name+" High Temp <span>Â· "+ACTIVE_DATE.display+"</span>";
  // Fetch Poly first (gets brackets + token IDs), then ensemble (needs brackets for range)
  await fetchPoly();
  await Promise.all([fetchEnsemble(),fetchMetar(),fetchGas()]);
  await fetchBooks();
  await refreshSummary(false);
  render();cd=RS;
}

// INIT
initBotSwitchFromCache();
loadApiSettingsToInputs();
setApiConnected(false);
updateActivePositionNotice();
refreshSummary(false);
renderCityNav();
selectCity("london"); // default
setInterval(()=>{cd--;$("badge").textContent="Auto-refresh "+cd+"s";if(cd<=0)refresh()},1000);
setInterval(()=>refreshSummary(false),15000);
</script>
</body>
</html>
